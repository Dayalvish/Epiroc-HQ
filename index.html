<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EPIROC CENTRAL PARAMETER VISUALIZER</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ey: #f1c40f; --bg: #0d0d0d; --card: #1a1a1a; --red: #ff4d4d; --green: #2ecc71; --blue: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; overflow: hidden; }
        
        /* 1. MODERN LOGIN OVERLAY */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: var(--card); padding: 40px; border-radius: 12px; 
            border-top: 5px solid var(--ey); width: 350px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .login-box input { 
            width: 100%; padding: 12px; margin: 10px 0; 
            background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box;
        }
        .login-box button { 
            width: 100%; padding: 12px; background: var(--ey); color: #000; 
            border: none; font-weight: bold; border-radius: 4px; cursor: pointer; margin-top: 10px;
        }

        /* 2. DASHBOARD CONTENT VISIBILITY */
        #dashboard-content { opacity: 0; transition: 0.8s; pointer-events: none; }
        .authorized #dashboard-content { opacity: 1; pointer-events: auto; }
        .authorized #login-overlay { display: none; }

        .header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--ey); padding-bottom: 10px; margin-bottom: 20px; }
        .user-badge { background: var(--ey); color: #000; padding: 4px 12px; border-radius: 15px; font-weight: bold; font-size: 0.85rem; margin-right: 15px; }

        .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; }
        .sidebar, .chart-area, .warning-sidebar { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        .live-dot { height: 12px; width: 12px; background: var(--green); border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }
        
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #111; font-size: 0.8rem; }
        .summary-table th, .summary-table td { padding: 10px; border: 1px solid #333; text-align: center; }
        .summary-table th { background: #222; color: var(--ey); text-transform: uppercase; font-size: 0.65rem; }
        
        .warning-sidebar { border: 1px solid var(--red); height: 750px; overflow-y: auto; }
        .alert-card { background: #222; padding: 12px; margin-bottom: 12px; border-left: 5px solid var(--red); border-radius: 4px; font-size: 0.8rem; text-align: left; }
        
        .mini-stats { margin-top: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mini-card { background: #222; padding: 12px; border-radius: 4px; text-align: center; border: 1px solid #333; }
        .mini-card small { color: #888; display: block; font-size: 0.7rem; margin-bottom: 4px; }
        .mini-card span { font-size: 1.1rem; font-weight: bold; color: var(--ey); }
        
        select, input { width: 100%; padding: 12px; margin-top: 8px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
        .btn-red { background: var(--red); color: white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold; width:100%; margin-top:10px;}
        .btn-green { background: #27ae60; color: white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold; width:100%; margin-top:10px;}
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="50">
        <h3 style="color:var(--ey); margin-bottom:20px; letter-spacing: 1px;">SYSTEM ACCESS</h3>
        <input type="text" id="userIn" placeholder="User ID">
        <input type="password" id="passIn" placeholder="Password">
        <button id="loginBtn" onclick="handleLogin()">AUTHORIZE ACCESS</button>
        <p id="login-msg" style="color:var(--red); font-size:0.8rem; margin-top:15px; font-weight: bold;"></p>
    </div>
</div>

<div id="dashboard-content">
    <div class="header">
        <div>
            <h1 style="margin:0;">EPIROC CENTRAL VISUALIZER</h1>
            <div style="font-size:0.9rem;">
                <span class="live-dot"></span>
                <span id="id-badge" class="user-badge">IDENTIFYING...</span>
                LIVE STATUS | <span id="last-sync">--:--:--</span>
            </div>
        </div>
        <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="55">
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <label>Model Classification</label>
            <select id="modelSelect" onchange="updateRigDropdown()"><option value="">All Models</option></select>
            
            <label style="display:block; margin-top:15px;">Target Rig ID</label>
            <select id="rigSelect" onchange="refresh()"><option>Loading...</option></select>
            
            <label style="display:block; margin-top:15px;">Target Month</label>
            <input type="month" id="monthFilter" onchange="refresh()">
            
            <label style="display:block; margin-top:15px;">Analysis Mode</label>
            <select id="chartMode" onchange="drawChart()">
                <option value="tempVsOil">Trend: Temp / Oil / RPM (Last 10 Audits)</option>
                <option value="loadVsComp">Load vs Compressor %</option>
                <option value="setBit">DTH: Set vs Bit Pressure</option>
                <option value="hydro_impact">Hydraulic: Impact/Feed/Damper</option>
            </select>

            <div class="mini-stats">
                <div class="mini-card"><small>Fleet Avg Load</small><span id="v-fleet-load">--</span></div>
                <div class="mini-card"><small>Active Assets</small><span id="v-active-rigs">--</span></div>
                <div class="mini-card"><small>Avg Air Set</small><span id="v-avg-airset">--</span></div>
                <div class="mini-card"><small>Air Efficiency</small><span id="v-air-eff">--</span></div>
            </div>

            <button onclick="window.print()" class="btn-red">üìÑ GENERATE PDF</button>
            <button onclick="exportToExcel()" class="btn-green">üìä EXCEL EXPORT</button>
        </div>

        <div class="chart-area">
            <div style="height:350px;"><canvas id="mainChart"></canvas></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px;">
                <h3 style="color:var(--ey); margin:0;">FLEET PERFORMANCE SUMMARY</h3>
                <input type="text" id="rigSearch" onkeyup="filterTable()" placeholder="Search Rig ID..." style="width:200px;">
            </div>
            <table class="summary-table" id="summary-tbl">
                <thead>
                    <tr><th rowspan="2">Rig ID</th><th rowspan="2">Audits</th><th colspan="4">Engine Health</th><th colspan="3">Productivity</th></tr>
                    <tr><th>Load %</th><th>Temp ¬∞C</th><th>Oil bar</th><th>Fuel bar</th><th>Air Set</th><th>Bit Pr</th><th>Impact</th></tr>
                </thead>
                <tbody id="fleet-summary-body"></tbody>
            </table>
        </div>

        <div class="warning-sidebar">
            <h3 style="color:var(--red); margin:0 0 15px 0; border-bottom: 1px solid #333; padding-bottom: 10px;">‚ö†Ô∏è TRIGGER ALERTS</h3>
            <div id="alert-list">Scanning...</div>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbzKoRIqY9N9RBDwqLtXgzbxQZqXaq6arKkG3dCcAR9lfy9rBvE8Ka0EpTJW_cAh9zVg/exec"; // PASTE NEW DEPLOYMENT URL HERE
    let chart = null, globalData = null;

    // --- 1. HANDLE LOGIN (Captures Column C Logger Detail) ---
    async function handleLogin() {
        const u = document.getElementById('userIn').value;
        const p = document.getElementById('passIn').value;
        const msg = document.getElementById('login-msg');
        
        msg.innerText = "Authenticating...";
        
        try {
            const res = await fetch(`${API}?get=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
            const data = await res.json();
            
            if(data.success) {
                // PERSIST HIERARCHY DETAILS
                sessionStorage.setItem('role', data.role);
                sessionStorage.setItem('region', data.region);
                sessionStorage.setItem('siteView', data.siteView);
                sessionStorage.setItem('logger', data.logger);
                
                // DISPLAY IDENTITY: Username-LoggerDetail (Col C)
                document.getElementById('id-badge').innerText = `${u}-${data.logger}`;

                document.body.classList.add('authorized');
                document.body.style.overflow = "auto";
                init();
            } else {
                msg.innerText = "Invalid ID or Password.";
            }
        } catch(e) {
            msg.innerText = "Connection Failed. Check API.";
        }
    }

    // HELPER: Ensures userRegion and siteView are sent to GS for EVERY request
    function getFullUrl(params) {
        const r = sessionStorage.getItem('region');
        const s = sessionStorage.getItem('siteView');
        return `${API}?${params}&userRegion=${encodeURIComponent(r)}&siteView=${encodeURIComponent(s)}&v=${Date.now()}`;
    }

    async function init() {
        const mRes = await fetch(getFullUrl("get=model_list"));
        const mList = await mRes.json();
        document.getElementById('modelSelect').innerHTML = '<option value="">All Models</option>' + mList.map(m => `<option value="${m}">${m}</option>`).join('');
        await updateRigDropdown(); 
        setInterval(refresh, 60000); 
    }

    async function updateRigDropdown() {
        const model = document.getElementById('modelSelect').value;
        const res = await fetch(getFullUrl(`get=list&model=${encodeURIComponent(model)}`));
        const rigs = await res.json();
        document.getElementById('rigSelect').innerHTML = rigs.map(id => `<option value="${id}">${id}</option>`).join('');
        refresh();
    }

    async function refresh() {
        const rig = document.getElementById('rigSelect').value;
        const month = document.getElementById('monthFilter').value;
        const model = document.getElementById('modelSelect').value;
        if(!rig) return;

        // FETCHING ALL DATA - NOW FILTERED BY REGION/SITE AT GS LEVEL
        const [dRes, sRes, wRes] = await Promise.all([
            fetch(getFullUrl(`fleetId=${encodeURIComponent(rig)}&month=${month}`)),
            fetch(getFullUrl(`get=fleet_summary&month=${month}&model=${model}`)),
            fetch(getFullUrl(`get=warnings`))
        ]);

        globalData = await dRes.json();
        const summary = await sRes.json();
        const alerts = await wRes.json();
        
        // UPDATE STAT CARDS
        if(summary.length > 0) {
            document.getElementById('v-fleet-load').innerText = (summary.reduce((s, r) => s + parseFloat(r.avgLoad), 0) / summary.length).toFixed(1) + "%";
            document.getElementById('v-active-rigs').innerText = summary.length;
            document.getElementById('v-avg-airset').innerText = (summary.reduce((s, r) => s + parseFloat(r.avgAirSet || 0), 0) / summary.length).toFixed(1);
            const totalBit = summary.reduce((s, r) => s + parseFloat(r.avgBitPr || 0), 0);
            const totalSet = summary.reduce((s, r) => s + parseFloat(r.avgAirSet || 0), 0.1); 
            document.getElementById('v-air-eff').innerText = ((totalBit/totalSet)*100).toFixed(1) + "%";
        }

        document.getElementById('last-sync').innerText = new Date().toLocaleTimeString();
        
        // POPULATE FILTERED SUMMARY TABLE
        document.getElementById('fleet-summary-body').innerHTML = summary.map(r => `<tr><td><b>${r.id}</b></td><td>${r.monthlyAudits}</td><td>${r.avgLoad}%</td><td>${r.avgTemp}</td><td>${r.avgOil}</td><td>${r.avgFuel}</td><td>${r.avgAirSet}</td><td>${r.avgBitPr}</td><td>${r.avgImpact}</td></tr>`).join('');
        
        // POPULATE FILTERED WARNINGS
        document.getElementById('alert-list').innerHTML = alerts.length ? alerts.map(a => `<div class="alert-card"><b>${a.id}</b> <span style="float:right;">${a.time}</span><br><small>${a.temp > a.tempLimit ? 'High Temp: '+a.temp+'¬∞C' : 'Low Oil: '+a.oil+'b'}</small></div>`).join('') : "‚úÖ Fleet Healthy";
        
        drawChart();
    }

    function drawChart() {
        const mode = document.getElementById('chartMode').value;
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();

        // LOGIC: Use 'history' (Last 10 Audits) for Trend mode, 'monthlyData' for others
        const isTrend = mode === 'tempVsOil';
        const d = isTrend ? globalData.history : globalData.monthlyData;
        
        if(!d || d.length === 0) return;

        let labels = d.map(x => x.date), datasets = [], scales = { 
            y: { position: 'left', grid: {color: '#333'} }, 
            y1: { position: 'right', grid: {drawOnChartArea: false} } 
        };

        if(mode === 'tempVsOil') {
            datasets = [
                { label: 'Oil bar', data: d.map(x => x.oil), borderColor: '#2ecc71', yAxisID: 'y', tension: 0.4 },
                { label: 'Temp ¬∞C', data: d.map(x => x.temp), borderColor: '#e74c3c', yAxisID: 'y1', tension: 0.3 },
                { label: 'RPM', data: d.map(x => x.rpm), borderColor: '#9b59b6', yAxisID: 'y1', borderDash: [5,5] }
            ];
        } else if(mode === 'loadVsComp') {
            scales.y1.display = false;
            datasets = [
                { label: 'Load %', data: d.map(x => x.engLoad), borderColor: '#f1c40f' },
                { label: 'Comp %', data: d.map(x => x.compPerc), borderColor: '#3498db' }
            ];
        } else if(mode === 'setBit') {
            scales.y1.display = false;
            datasets = [
                { label: 'Air Set', data: d.map(x => x.fullAirSet), borderColor: '#2ecc71' },
                { label: 'Bit Pr', data: d.map(x => x.pressureFull), borderColor: '#e74c3c' }
            ];
        } else if(mode === 'hydro_impact') {
            datasets = [
                { label: 'Impact', data: d.map(x => x.highImpact), borderColor: '#f1c40f' },
                { label: 'Feed', data: d.map(x => x.feedPrHigh), borderColor: '#ff5722' },
                { label: 'Damper', data: d.map(x => x.damperPrHigh), borderColor: '#3498db' }
            ];
        }
        chart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, scales } });
    }

    function filterTable() {
        var input = document.getElementById("rigSearch"), filter = input.value.toUpperCase(), tr = document.getElementById("summary-tbl").getElementsByTagName("tr");
        for (var i = 2; i < tr.length; i++) {
            var td = tr[i].getElementsByTagName("td")[0];
            if (td) { tr[i].style.display = (td.textContent || td.innerText).toUpperCase().indexOf(filter) > -1 ? "" : "none"; }
        }
    }

    function exportToExcel() {
        let table = document.getElementById("summary-tbl"), url = 'data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
        let link = document.createElement('a'); link.download = "Epiroc_Fleet_Summary.xls"; link.href = url; link.click();
    }
</script>
</body>
</html>
