<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EPIROC CENTRAL PARAMETER DASH VIEW</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* =========================================
           1. CORE VARIABLES & GLOBAL RESET
           ========================================= */
        :root { 
            --ey: #f1c40f; 
            --bg: #0d0d0d; 
            --card: #1a1a1a; 
            --red: #ff4d4d; 
            --green: #2ecc71; 
            --blue: #3498db; 
        }
        
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); 
            color: #fff; 
            -webkit-font-smoothing: antialiased;
        }

        /* =========================================
           2. AUTHENTICATION & LOGIN OVERLAY
           ========================================= */
        #login-overlay { 
            position: fixed; 
            inset: 0; 
            background: var(--bg); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
        }
        .login-box { 
            background: var(--card); 
            padding: 35px; 
            border-radius: 12px; 
            border-top: 5px solid var(--ey); 
            width: 320px; 
            text-align: center; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.9);
        }
        .login-box input { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            background: #222; 
            border: 1px solid #444; 
            color: #fff; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        .login-box button { 
            width: 100%; 
            padding: 12px; 
            background: var(--ey); 
            color: #000; 
            border: none; 
            font-weight: bold; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: 0.3s;
        }
        .login-box button:hover { background: #d4ac0d; }

        /* =========================================
           3. DASHBOARD MAIN STRUCTURE
           ========================================= */
        #dashboard-content { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            padding: 12px; 
            box-sizing: border-box; 
            opacity: 0; 
            transition: opacity 0.8s ease-in-out; 
        }
        .authorized #dashboard-content { opacity: 1; pointer-events: auto; }
        .authorized #login-overlay { display: none; }

        .header { 
            display: grid; 
            grid-template-columns: 260px 1fr 260px; 
            align-items: center; 
            border-bottom: 2px solid var(--ey); 
            padding-bottom: 8px; 
            margin-bottom: 12px; 
            flex-shrink: 0; 
        }
        .header-left { display: flex; flex-direction: column; align-items: flex-start; }
        .header-center { text-align: center; }
        .header-center h1 { 
            margin: 0; 
            font-size: 1.4rem; 
            letter-spacing: 2px; 
            color: var(--ey); 
            text-transform: uppercase;
        }
        
        .user-badge { 
            background: var(--ey); 
            color: #000; 
            padding: 3px 12px; 
            border-radius: 15px; 
            font-weight: bold; 
            font-size: 0.7rem; 
            margin-top: 5px; 
            display: inline-block; 
        }

        .live-dot { 
            height: 8px; 
            width: 8px; 
            background: var(--green); 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 6px; 
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 
            70% { box-shadow: 0 0 0 8px rgba(46, 204, 113, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } 
        }

     /* =========================================
   5. MAIN GRID SYSTEM & FIXED SCALING
   ========================================= */
.main-layout { 
    display: grid; 
    grid-template-columns: 260px 1fr 280px; 
    gap: 12px; 
    flex-grow: 1; 
    height: calc(100vh - 140px); 
    min-height: 0; 
}

.sidebar {
    background: var(--card); 
    padding: 15px; 
    border-radius: 8px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.6); 
    overflow-y: auto; 
    height: 100%; 
    box-sizing: border-box; 
}

/* --- CHART & TABLE AREA --- */
.chart-area { 
    background: var(--card); 
    padding: 10px; 
    border-radius: 8px; 
    display: flex;              
    flex-direction: column;     
    height: 100%; 
    box-sizing: border-box; 
    overflow: hidden; 
}

#chart-container {
    flex: 0 0 40%; /* Fixed height for chart to allow table space */
    position: relative;
    width: 100%;
    min-height: 0;
}

.table-scroll-container {
    flex: 1 1 auto;   /* Fills the remaining bottom space */
    overflow-y: auto; /* Enables the vertical scrollbar */
    min-height: 0;    /* Critical for flex-scrolling to work */
    margin-top: 10px;
    border: 1px solid #333;
}

/* --- ALERT BOX & SCROLLBAR FIXES --- */
.sidebar-right-split { 
    display: flex; 
    flex-direction: column; 
    gap: 12px; 
    height: 100%; 
}

.alert-box {
    display: flex;
    flex-direction: column;
    background: var(--card);
    padding: 15px;
    border-radius: 8px;
    height: 480px; /* Locked height: Prevents layout shifting */
    overflow: hidden; 
}

#alert-list {
    flex-grow: 1;
    overflow-y: auto; 
    padding-right: 5px;
}

/* Custom Red Scrollbar for Alerts */
#alert-list::-webkit-scrollbar { 
    width: 4px; 
}
#alert-list::-webkit-scrollbar-thumb { 
    background: var(--red); 
    border-radius: 10px; 
}

.vitals-box { 
    flex: 1; 
    background: var(--card); 
    padding: 15px; 
    border-radius: 8px; 
}
     /* =========================================
   BOLDER RADIAL DIAL GAUGE STYLING
   ========================================= */
.gauge-partition {
    position: relative;
    display: flex;           /* FORCES HORIZONTAL */
    flex-direction: row;     /* FORCES HORIZONTAL */
    justify-content: space-around; 
    align-items: center;
    background: rgba(0,0,0,0.8);
    border: 1px solid #444;
    border-radius: 4px;
    padding: 20px 10px;
    margin: 5px 0;
    min-height: 160px;       /* Keeps the box stable */
    overflow: hidden;        /* Prevents content spill */
}

.date-badge {
    position: absolute;
    top: 50%;
    left: 15px;
    transform: translateY(-50%);
    font-weight: bold;
    font-size: 0.8rem;
    color: var(--ey);
    border-left: 3px solid var(--ey);
    padding-left: 10px;
    z-index: 10;
    background: rgba(13, 13, 13, 0.7); /* Background so it doesn't overlap text */
}

.dial-wrapper {
    position: relative;
    width: 130px;            /* Narrowed slightly to fit 3 in a row */
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
}
    /* Bolder Needle */
    .needle {
        transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: 50px 50px;
        stroke-width: 4px; /* Bolder needle */
    }

    .dial-value {
        font-size: 1.7rem; /* Bigger numerical view */
        font-weight: 900; 
        color: #fff; /* White text for high contrast */
        font-family: 'Courier New', monospace;
        margin-top: -20px;
        z-index: 2;
        text-shadow: 0 0 10px rgba(0,0,0,1);
    }

    .dial-label {
        font-size: 0.7rem;
        color: var(--ey); /* Gold labels */
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-top: 5px;
    }        .summary-table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        .summary-table th { background: #222; color: var(--ey); position: sticky; top: 0; z-index: 10; }
        .summary-table td { padding: 6px; border: 1px solid #333; text-align: center; }

        <div class="sidebar-right-split">
    <div class="alert-box">
        <h3 style="color:var(--red); margin:0; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
            <span>‚ö†Ô∏è FLEET ALERTS</span>
            <span id="alert-count-badge" style="background:#444; color:white; padding:2px 10px; border-radius:4px; font-size:0.9rem; font-family: monospace;">0</span>
        </h3>
        <div id="alert-list" style="flex-grow: 1; overflow-y: auto; margin-top: 10px; max-height: 400px;">
            Scanning...
        </div>
    </div>

    <div class="vitals-box">
        <h3 style="color:var(--ey); margin:0; border-bottom: 1px solid #333; padding-bottom: 10px;">üìä MACHINE VITALS</h3>
        <table class="vital-table" style="width:100%; margin-top:10px;">
            <tr><td class="v-label">Boost Pressure</td><td class="v-value" id="v-boost">0</td></tr>
            <tr><td class="v-label">Fuel Pressure</td><td class="v-value" id="v-fuel">0</td></tr>
            <tr><td class="v-label">Receiver PR</td><td class="v-value" id="v-receiver">0</td></tr>
            <tr><td class="v-label">Hyd-Oil Temp</td><td class="v-value" id="v-temp">0¬∞C</td></tr>
        </table>
    </div>
</div>
        .alert-box { flex: 1.6; background: var(--card); padding: 15px; border-radius: 8px; overflow-y: auto; }
        .vitals-box { flex: 1; background: var(--card); padding: 15px; border-radius: 8px; }

        .mini-stats { margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mini-card { background: #222; padding: 10px; border-radius: 4px; text-align: center; border: 1px solid #333; }
        .mini-card small { color: #888; display: block; font-size: 0.6rem; margin-bottom: 4px; }
        .mini-card span { font-size: 1.1rem; font-weight: bold; color: var(--ey); }

        select, input { width: 100%; padding: 8px; margin-top: 6px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 0.85rem; box-sizing: border-box; }
        input[type="month"] { color: #ffffff !important; color-scheme: dark; }
        label { font-size: 0.7rem; color: #888; text-transform: uppercase; display: block; margin-top: 12px; }

        .btn-red, .btn-green { padding: 8px; border-radius: 4px; font-weight: bold; width: 100%; cursor: pointer; border: none; font-size: 0.75rem; transition: 0.3s; text-transform: uppercase; }
        .btn-red { background: var(--red); color: white; margin-top: 15px; }
        .btn-green { background: #27ae60; color: white; margin-top: 8px; }

        .alert-trigger { color: var(--red) !important; animation: pulse-red 0.8s infinite alternate; }
        @keyframes pulse-red { from { opacity: 1; } to { opacity: 0.5; } }

        #auditWarning { display: none; position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: var(--red); color: white; padding: 12px 30px; border-radius: 8px; font-weight: bold; z-index: 10000; animation: blinker 1s linear infinite; box-shadow: 0 0 25px rgba(255,77,77,0.6); }
        @keyframes blinker { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--ey); }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="50">
        <h3>SYSTEM ACCESS</h3>
        <input type="text" id="userIn" placeholder="User ID">
        <input type="password" id="passIn" placeholder="Password">
        <button onclick="handleLogin()">AUTHORIZE ACCESS</button>
        <p id="login-msg" style="color:var(--red); font-size:0.8rem; margin-top:15px;"></p>
    </div>
</div>

<div id="dashboard-content">
    <div id="auditWarning" onclick="this.style.display='none'" title="Click to dismiss">
        ‚ö†Ô∏è RIG HAS NOT COVERED MANDATORY MINIMUM AUDITS
    </div>
    
    <div class="header">
        <div class="header-left">
            <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="45">
            <div><span class="live-dot"></span><span id="id-badge" class="user-badge">IDENTIFYING...</span></div>
        </div>
        <div class="header-center">
            <h1>EPIROC CENTRAL PARAMETER DASH VIEW</h1>
            <div style="font-size: 0.8rem; color: #888; margin-top:5px;">LIVE STATUS | <span id="last-sync">--:--:--</span></div>
        </div>
        <div class="header-right"></div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div class="filter-group" id="mgmt-city-box" style="display:none; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label style="color: var(--ey); font-size: 0.85rem;">REGION SECTOR</label>
                    <button onclick="resetCityFilter()" style="background: none; border: 1px solid var(--ey); color: var(--ey); font-size: 0.65rem; padding: 2px 6px; cursor: pointer; border-radius: 3px;">RESET</button>
                </div>
                <select id="cityFocus" onchange="applyGlobalFilters()">
                    <option value="All">All India (National)</option>
                    <option value="Ranchi">Ranchi</option>
                    <option value="Hyderabad">Hyderabad</option>
                    <option value="Delhi">Delhi</option>
                    <option value="Nagpur">Nagpur</option>
                    <option value="Udaipur">Udaipur</option>
                    <option value="Kolkata">Kolkata</option>
                </select>
            </div>

            <label>Model Classification</label>
            <select id="modelSelect" onchange="updateRigDropdown()">
                <option value="">All Models</option>
            </select>

            <div class="filter-group" style="margin-top:15px;">
                <label for="dataSource">Data View:</label>
                <select id="dataSource" onchange="refresh()">
                    <option value="active" selected>Live (Present)</option>
                    <option value="history">Archive (Pre-Nov 2025)</option>
                </select>
            </div>
            
            <label style="display:block; margin-top:15px;">Target Rig ID</label>
            <select id="rigSelect" onchange="refresh()"><option>Loading...</option></select>
            
            <label style="display:block; margin-top:15px;">Target Month</label>
            <input type="month" id="monthFilter" onchange="refresh()">

            <label style="display:block; margin-top:15px; color: #fff;">Analysis Mode</label>
<select id="chartMode" onchange="drawChart(); startLivelyGauges(true);" style="width:100%; background:#222; color:#fff; border:1px solid #444; padding:5px;">
    <option value="tempVsOil">Trend: Temp / Oil / RPM</option>
    <option value="loadVsComp">Load vs Compressor %</option>
    <option value="rpmVsCompTemp">RPM vs Comp Temp (L/H)</option> 
    <option value="fuelVsBoost">Fuel Pr vs Boost Pr</option> 
    <option value="receiverAnalysis">Receiver Pressure Analysis (Col O vs L/M)</option>
    <option value="setVsBit">DTH: Set vs Bit Pressure</option>
    <option value="hydro_impact">Hydraulic: Impact/Feed/Damper</option>
</select>

            <div class="mini-stats">
                <div class="mini-card"><small>Fleet Avg Load</small><span id="v-fleet-load">--</span></div>
                <div class="mini-card"><small>Active Assets</small><span id="v-active-rigs">--</span></div>
            </div>

            <button onclick="window.print()" class="btn-red">üìÑ GENERATE PDF</button>
            <button onclick="exportToExcel()" class="btn-green">üìä EXCEL EXPORT</button>
        </div>

        <div class="chart-area">
            <div id="chart-container">
                <canvas id="mainChart"></canvas>
            </div>

            <div class="gauge-partition" id="gauge-row">
                <div style="color:var(--green); border:1px solid; padding:2px 8px; border-radius:10px; font-size:0.65rem;">
                    SEQ: <span id="current-seq">0</span>
                </div>
            </div>

            <h3 style="color:var(--ey); margin: 5px 0;">FLEET PERFORMANCE SUMMARY</h3>
            <div class="table-scroll-container">
                <table class="summary-table" id="summary-tbl">
                    <thead>
                        <tr><th rowspan="2">Rig ID</th><th rowspan="2">Audits</th><th colspan="4">Engine Health</th><th colspan="3">Productivity</th></tr>
                        <tr><th>Load %</th><th>Temp ¬∞C</th><th>Oil bar</th><th>Fuel bar</th><th>Air Set</th><th>Bit Pr</th><th>Impact</th></tr>
                    </thead>
                    <tbody id="fleet-summary-body"></tbody>
                </table>
            </div>
        </div>

        <div class="sidebar-right-split" style="display: flex; flex-direction: column; gap: 12px; height: 100%;">
    
    <div class="alert-box" style="flex: 0 0 450px; display: flex; flex-direction: column; background: var(--card); padding: 15px; border-radius: 8px; overflow: hidden; border: 1px solid #333;">
        <h3 style="color:var(--red); margin: 0 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 0.9rem;">‚ö†Ô∏è FLEET ALERTS</span>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button onclick="exportTriggerReport()" style="background: var(--red); border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-weight: bold;">
                    üì• CSV REPORT
                </button>
                <span id="alert-count-badge" style="background:#444; color:white; padding:2px 10px; border-radius:4px; font-size:0.9rem; font-family: monospace;">0</span>
            </div>
        </h3>
        
        <div id="alert-list" style="flex-grow: 1; overflow-y: auto; padding-right: 5px;">
            Scanning...
        </div>
    </div>

    <div class="vitals-box" style="flex-grow: 1; background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #444;">
        <h3 style="color:var(--ey); margin:0; border-bottom: 1px solid #333; padding-bottom: 10px;">üìä MACHINE VITALS</h3>
        <table class="vital-table" style="width:100%; margin-top:10px; border-collapse: collapse;">
            <tr><td style="padding: 5px 0; color: #aaa; font-size: 0.85rem;">Boost Pressure</td><td id="v-boost" style="text-align: right; color: var(--green); font-weight: bold;">0</td></tr>
            <tr><td style="padding: 5px 0; color: #aaa; font-size: 0.85rem;">Fuel Pressure</td><td id="v-fuel" style="text-align: right; color: var(--green); font-weight: bold;">0</td></tr>
            <tr><td style="padding: 5px 0; color: #aaa; font-size: 0.85rem;">Receiver PR</td><td id="v-receiver" style="text-align: right; color: var(--green); font-weight: bold;">0</td></tr>
            <tr><td style="padding: 5px 0; color: #aaa; font-size: 0.85rem;">Hyd-Oil Temp</td><td id="v-temp" style="text-align: right; color: var(--green); font-weight: bold;">0¬∞C</td></tr>
        </table>
        <div id="vitals-date-stamp" style="font-size: 0.65rem; color: #666; margin-top: 10px; text-align: right;">Last Audit: --</div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbxxPcfZSJ64s-SifwHxoDUhbqajLT3w4zAn4ILdrxBkXfi_fePUqSW7sKixA8TXqr96/exec"; 
    let chart = null, globalData = null;
    var livelyTimer = null;
    var currentIdx = 0;

    async function handleLogin() {
        const u = document.getElementById('userIn').value;
        const p = document.getElementById('passIn').value;
        const msg = document.getElementById('login-msg');
        if (!u || !p) { msg.innerText = "Please enter credentials."; return; }
        msg.innerText = "Authenticating...";
        try {
            const resp = await fetch(`${API}?get=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
            const data = await resp.json();
            if (data.success) {
                sessionStorage.setItem('region', data.region);
                sessionStorage.setItem('siteView', data.siteView);
                sessionStorage.setItem('user', u);
                sessionStorage.setItem('logger', data.logger);
                document.getElementById('id-badge').innerText = `${u}-${data.logger}`;
                if(data.role === 'mgmt') document.getElementById('mgmt-city-box').style.display = 'block'; 
                document.body.classList.add('authorized');
                init(); 
            } else { msg.innerText = "Invalid Login."; }
        } catch (e) { msg.innerText = "Connection Failed."; }
    }

    function getFullUrl(params) {
        const r = sessionStorage.getItem('region'), s = sessionStorage.getItem('siteView'), u = sessionStorage.getItem('user');
        return `${API}?${params}&userRegion=${encodeURIComponent(r)}&siteView=${encodeURIComponent(s)}&user=${encodeURIComponent(u)}&v=${Date.now()}`;
    }

    async function init() {
        const now = new Date(); 
        document.getElementById('monthFilter').value = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
        try {
            const mRes = await fetch(getFullUrl("get=model_list"));
            const mList = await mRes.json();
            document.getElementById('modelSelect').innerHTML = '<option value="">All Models</option>' + mList.map(m => `<option value="${m}">${m}</option>`).join('');
            await updateRigDropdown(); 
            if (window.refreshInterval) clearInterval(window.refreshInterval);
            window.refreshInterval = setInterval(() => { refresh(); }, 60000); 
        } catch (e) { console.error("Init Error:", e); }
    }

    async function updateRigDropdown() {
        const model = document.getElementById('modelSelect').value;
        const rigSelect = document.getElementById('rigSelect');
        rigSelect.innerHTML = '<option value="">Loading...</option>';
        try {
            const res = await fetch(getFullUrl(`get=list&model=${encodeURIComponent(model)}`));
            const rigs = await res.json();
            if (rigs && rigs.length > 0) {
                rigSelect.innerHTML = rigs.map((id, index) => `<option value="${id}" ${index === 0 ? 'selected' : ''}>${id}</option>`).join('');
            } else { rigSelect.innerHTML = '<option value="">No Rigs Found</option>'; }
            refresh();
        } catch (e) { console.error("Rig list sync failed:", e); }
    }

    async function refresh() {
    const rig = document.getElementById('rigSelect').value;
    const month = document.getElementById('monthFilter').value; 
    const mode = document.getElementById('dataSource').value; 
    
    // üöÄ THE FIX: Use an AbortController to prevent "Message channel closed" errors
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout

    try {
        const res = await fetch(getFullUrl(`fleetId=${encodeURIComponent(rig)}&month=${month}&mode=${mode}`), {
            signal: controller.signal
        });
        
        const data = await res.json();
        clearTimeout(timeoutId);

        // üöÄ THE HANDSHAKE
        globalData = data; 
        updateUI(data); 
        
        console.log("60s Heartbeat: Dashboard Updated Successfully");
    } catch (err) {
        if (err.name === 'AbortError') {
            console.warn("Refresh timed out. Retrying on next heartbeat.");
        } else {
            console.error("Refresh Error:", err);
        }
    }
}

    function updateUI(data) {
    if (!data) return;

    // üöÄ CRITICAL: Save new data to global scope so gauges/charts use fresh values
    globalData = data; 
    
    const summaryBody = document.getElementById('fleet-summary-body');
    const alertList = document.getElementById('alert-list');
    const badge = document.getElementById('alert-count-badge');
    const warningEl = document.getElementById('auditWarning');

    try {
        // 1. Fleet Summary Table
        if (data.summary && data.summary.length > 0) {
            summaryBody.innerHTML = data.summary.map(r => {
                const isCritical = (data.globalAlerts || []).some(a => a.rig === r.id);
                return `
                    <tr class="${isCritical ? 'critical-row' : ''}" data-region="${r.region || ''}" data-model="${r.model || ''}">
                        <td><b>${r.id}</b> ${isCritical ? '<span class="alert-dot"></span>' : ''}</td>
                        <td>${r.audits || 0}</td>
                        <td style="color:${parseFloat(r.avgLoad) > 90 ? 'var(--red)' : 'inherit'}">${r.avgLoad || 0}%</td>
                        <td>${r.avgTemp || 0}</td><td>${r.avgOil || 0}</td><td>${r.avgFuel || 0}</td>
                        <td>${r.avgAir || 0}</td><td>${r.avgBit || 0}</td><td>${r.avgImpact || 0}</td>
                    </tr>`;
            }).join('');
            
            const totalLoad = data.summary.reduce((acc, r) => acc + (parseFloat(r.avgLoad) || 0), 0);
            document.getElementById('v-fleet-load').innerText = (totalLoad / data.summary.length).toFixed(1) + "%";
            document.getElementById('v-active-rigs').innerText = data.summary.length;
            
            // Re-apply filters immediately
            applyGlobalFilters(); 
        }

        // 2. Machine Vitals & Grace Period Logic
        const currentRig = document.getElementById('rigSelect').value;
        const rigData = data.summary ? data.summary.find(s => s.id === currentRig) : null;
        
        if (warningEl) {
            const today = new Date();
            const requiredCount = today.getDate() - 1; 
            if (rigData && rigData.audits < requiredCount) {
                warningEl.style.display = 'block';
                warningEl.innerText = `‚ö†Ô∏è ${currentRig}: ${rigData.audits} AUDITS. ${requiredCount} REQUIRED.`;
                
                // üïí Auto-hide after 15 seconds to clear the screen
                setTimeout(() => { warningEl.style.display = 'none'; }, 15000); 
            } else { 
                warningEl.style.display = 'none'; 
            }
        }

        // Update Side Vitals
        if (data.vitals && data.vitals.date !== "N/A") {
            const v = data.vitals;
            document.getElementById('v-boost').innerText = v.boost || "0";
            document.getElementById('v-fuel').innerText = v.fuel || "0";
            document.getElementById('v-receiver').innerText = v.receiver || "0";
            document.getElementById('v-temp').innerText = (v.temp || "0") + "¬∞C";
            document.getElementById('vitals-date-stamp').innerText = "Last Audit: " + (v.date || "N/A");
        }

        // 3. Alerts List & Header Badge (Your existing logic)
        const alerts = data.globalAlerts || [];
        if (badge) {
            badge.innerText = alerts.length;
            badge.style.display = alerts.length > 0 ? 'inline-block' : 'none';
        }
        
        alertList.innerHTML = alerts.length > 0 ? alerts.map(a => `
            <div class="alert-item" style="border-left: 3px solid var(--red); padding: 8px; margin-bottom: 8px; background: rgba(255,0,0,0.05); border-radius: 4px;">
                <div style="display:flex; justify-content:space-between;">
                    <strong>${a.rig}</strong>
                    <span style="font-size:0.7rem; color:#888;">${a.date || ''}</span>
                </div>
                <div style="font-size:0.8rem;">
                    ${a.parameter}: <span style="color:var(--red); font-weight:bold;">${a.value}</span>
                </div>
            </div>`).join('') : '<div style="color:var(--green); text-align:center; padding:15px;">‚úÖ SYSTEMS NORMAL</div>';

        // 4. üî• REFRESH VISUALS (Fixed Handshake)
        console.log("UI Update: Refreshing Visuals...");

        // üöÄ THE FIX: We must update globalData BEFORE calling the drawing functions
        globalData = data; 

        if (typeof drawChart === "function") {
            // This forces the trend lines to move
            drawChart(); 
        }
        
        if (typeof startLivelyGauges === "function") {
            // This forces the dials to sync with the new data sequence
            startLivelyGauges(true);
        }

    } catch (error) { 
        console.error("UI Update Error:", error); 
    }
} // End of updateUI

    function applyGlobalFilters() {
        const selRegion = document.getElementById('cityFocus').value;
        const selModel = document.getElementById('modelSelect').value;
        const rows = document.querySelectorAll('#fleet-summary-body tr');
        rows.forEach(row => {
            const rReg = row.getAttribute('data-region') || "";
            const rMod = row.getAttribute('data-model') || "";
            const regionMatch = (selRegion === "All India (National)" || selRegion === "All" || rReg === selRegion);
            const modelMatch = (selModel === "" || rMod === selModel);
            row.style.display = (regionMatch && modelMatch) ? "" : "none";
        });
    }

   function startLivelyGauges(forceReset = false) {
    if (livelyTimer) { clearInterval(livelyTimer); livelyTimer = null; }
    
    const selectedRig = document.getElementById('rigSelect').value;
    const d = (globalData?.monthlyData || []).filter(e => e.rigId === selectedRig);
    const T = globalData?.thresholds || {};
    const row = document.getElementById('gauge-row');
    
    if (!row || d.length === 0) return;
    if (forceReset) currentIdx = 0;

    livelyTimer = setInterval(() => {
        if (!d[currentIdx]) currentIdx = 0;
        const entry = d[currentIdx];
        const mode = document.getElementById('chartMode').value;
        
        let html = `<div class="date-badge">AUDIT: ${entry.date}</div>`;
        let config = [];

        if (mode === 'tempVsOil') {
            config = [
                { lab: 'Oil bar', val: entry.oil, max: 6, limit: T['Engine oil pressure_Low'], isLow: true, decimal: true },
                { lab: 'RPM', val: entry.rpm, max: 2200, limit: T['Engine RPM Drilling_High'] || 1800, isLow: false },
                { lab: 'Temp ¬∞C', val: entry.temp, max: 100, limit: T['Engine Temp_High'], isLow: false }
            ];
        } else if (mode === 'loadVsComp') {
            config = [
                { lab: 'Eng Load %', val: entry.load, max: 90, limit: 80, isLow: false },
                { lab: 'Comp %', val: entry.comp, max: 100, limit: 90, isLow: false }
            ];
        } else if (mode === 'rpmVsCompTemp') {
            config = [
                { lab: 'RPM', val: entry.rpm, max: 3000, limit: 2200, isLow: false },
                { lab: 'Comp T(L)', val: entry.compTempL, max: 130, limit: 120, isLow: false },
                { lab: 'Comp T(H)', val: entry.compTempH, max: 130, limit: 120, isLow: false }
            ];
        } else if (mode === 'fuelVsBoost') {
            config = [
                { lab: 'Fuel bar', val: entry.fuel, max: 15, limit: T['Fuel Pressure_Low'] || 5, isLow: true, decimal: true },
                { lab: 'Boost bar', val: entry.boost, max: 2, limit: 1.2, isLow: false, decimal: true }
            ];
        } else if (mode === 'setVsBit') {
            config = [
                { lab: 'Set bar', val: entry.air, max: 35, limit: 20, isLow: true, decimal: true },
                { lab: 'Bit bar', val: entry.bit, max: 35, limit: 18, isLow: true, decimal: true }
            ];
        } else if (mode === 'hydro_impact') {
            config = [
                { lab: 'Impact', val: entry.impact, max: 220, limit: 180, isLow: false },
                { lab: 'Feed', val: entry.feed, max: 105, limit: 60, isLow: false },
                { lab: 'Damper', val: entry.damper, max: 100, limit: 50, isLow: false }
            ];
        // üöÄ THE MISSING LINK: Added for Receiver Pressure Analysis
        } else if (mode === 'receiverAnalysis') {
            const lowL = parseFloat(globalData.limits?.receiverLow) || 0;
            const highL = parseFloat(globalData.limits?.receiverHigh) || 0;
            
            config = [
                { 
                    lab: 'Receiver Pr', 
                    val: entry.receiver, 
                    max: 12, 
                    limit: highL || 8, // Uses the static High Limit we sent
                    isLow: false, 
                    decimal: true 
                }
            ];
        }

        config.forEach(g => {
            const val = parseFloat(g.val || 0);
            const angle = (Math.min(val / g.max, 1) * 180) - 90;
            const isAlert = g.isLow ? (val <= g.limit && val > 0) : (val >= g.limit);
            const color = isAlert ? 'var(--red)' : 'var(--ey)';
            html += `
                <div class="dial-wrapper">
                    <svg viewBox="0 0 100 65">
                        <path d="M10,50 A40,40 0 0,1 90,50" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8" />
                        <line class="needle" x1="50" y1="50" x2="${50 + 38 * Math.cos((angle - 90) * Math.PI / 180)}" y2="${50 + 38 * Math.sin((angle - 90) * Math.PI / 180)}" stroke="${color}" stroke-width="4"/>
                    </svg>
                    <div class="dial-value" style="color:${color}">${g.decimal ? val.toFixed(1) : Math.round(val)}</div>
                    <span class="dial-label">${g.lab}</span>
                </div>`;
        });
        row.innerHTML = html;
        currentIdx = (currentIdx + 1) % d.length;
    }, 2000);
}
function drawChart() {
    if (!globalData?.monthlyData) return;
    const canvas = document.getElementById('mainChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    if (chart) {
        chart.destroy();
        chart = null;
    }

    const selectedRig = document.getElementById('rigSelect').value;
    const mode = document.getElementById('chartMode').value;
    const d = globalData.monthlyData.filter(e => e.rigId === selectedRig);
    if (d.length === 0) return;

    const labels = d.map(x => x.date);
    let datasets = [];
    let scales = {
        x: { grid: { color: '#333' }, ticks: { color: '#888', font: { size: 10 } } },
        y: { grid: { color: '#333' }, ticks: { color: '#fff' } }
    };

    if (mode === 'tempVsOil') {
        datasets = [
            { label: 'Oil', data: d.map(x => x.oil), borderColor: '#2ecc71', yAxisID: 'y' },
            { label: 'Temp', data: d.map(x => x.temp), borderColor: '#ff4d4d', yAxisID: 'y1' },
            { label: 'RPM', data: d.map(x => x.rpm), borderColor: '#3498db', yAxisID: 'y2', borderDash: [5, 5] }
        ];
        scales.y1 = { position: 'right', grid: { drawOnChartArea: false } };
        scales.y2 = { position: 'right', min: 0, max: 3000, grid: { drawOnChartArea: false } };
    } else if (mode === 'loadVsComp') {
        datasets = [
            { label: 'Eng Load %', data: d.map(x => x.load), borderColor: '#f1c40f' },
            { label: 'Comp %', data: d.map(x => x.comp), borderColor: '#3498db' }
        ];
    } else if (mode === 'rpmVsCompTemp') {
        datasets = [
            { label: 'RPM', data: d.map(x => x.rpm), borderColor: '#3498db', yAxisID: 'y1' },
            { label: 'Comp T(L)', data: d.map(x => x.compTempL), borderColor: '#2ecc71', yAxisID: 'y' },
            { label: 'Comp T(H)', data: d.map(x => x.compTempH), borderColor: '#ff4d4d', yAxisID: 'y' }
        ];
        scales.y1 = { position: 'right', min: 0, max: 3000 };
    } else if (mode === 'fuelVsBoost') {
        datasets = [
            { label: 'Fuel (bar)', data: d.map(x => x.fuel), borderColor: '#f1c40f', yAxisID: 'y' },
            { label: 'Boost (bar)', data: d.map(x => x.boost), borderColor: '#3498db', yAxisID: 'y1' }
        ];
        scales.y1 = { position: 'right', min: 0, max: 5 };
    } else if (mode === 'setVsBit') {
        datasets = [
            { label: 'Set bar', data: d.map(x => x.air), borderColor: '#2ecc71' },
            { label: 'Bit bar', data: d.map(x => x.bit), borderColor: '#f39c12' }
        ];
    } else if (mode === 'hydro_impact') {
        datasets = [
            { label: 'Impact', data: d.map(x => x.impact), borderColor: '#f1c40f' },
            { label: 'Feed', data: d.map(x => x.feed), borderColor: '#e67e22' },
            { label: 'Damper', data: d.map(x => x.damper), borderColor: '#3498db' }
        ];
    } else if (mode === 'hydro_impact') {
        datasets = [
            { label: 'Impact', data: d.map(x => x.impact), borderColor: '#f1c40f' },
            { label: 'Feed', data: d.map(x => x.feed), borderColor: '#e67e22' },
            { label: 'Damper', data: d.map(x => x.damper), borderColor: '#3498db' }
        ];
} else if (mode === 'receiverAnalysis') {
        const lowL = parseFloat(globalData.limits?.receiverLow) || 0;
        const highL = parseFloat(globalData.limits?.receiverHigh) || 0;
        const plotData = d.map(x => x.receiver);

        // This ensures the chart is always tall enough to see the High Limit + a buffer
        const chartCeiling = Math.max(10, Math.ceil(highL + .5)); 

        datasets = [
            { 
                label: 'Actual Receiver Pressure', 
                data: plotData, 
                borderColor: '#3498db', 
                borderWidth: 4, 
                fill: false,
                tension: 0.2,
                pointRadius: 4
            },
            { 
                label: `Low Limit (${lowL})`, 
                data: new Array(labels.length).fill(lowL), 
                borderColor: '#f1c40f', 
                borderDash: [10, 5], 
                pointRadius: 0,
                fill: false 
            },
            { 
                label: `High Limit (${highL})`, 
                data: new Array(labels.length).fill(highL), 
                borderColor: '#ff4d4d', 
                borderDash: [10, 5], 
                pointRadius: 0,
                fill: false 
            }
        ];

        

        scales = {
            x: { grid: { color: '#333' }, ticks: { color: '#888' } },
            y: { 
                display: true,
                beginAtZero: true, 
                max: chartCeiling, 
                grid: { color: '#444' },
                ticks: { 
                    color: '#fff',
                    stepSize: 0.2, // üöÄ Keeps your precise engineering increments
                    callback: function(value) {
                        return value.toFixed(1); 
                    }
                }
            }
        };
        delete scales.y1;
        delete scales.y2;
    }
    chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#fff' } } },
            scales: scales
        }
    });
} // Closes drawChart properly

function exportToExcel() {
    let table = document.getElementById("summary-tbl");
    if(!table) return alert("Summary table not found.");
    let url = 'data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
    let link = document.createElement('a');
    link.download = "Rig_Report.xls";
    link.href = url;
    link.click();
}

function exportTriggerReport() {
    if (!globalData?.globalAlerts || globalData.globalAlerts.length === 0) {
        return alert("No active triggers to export.");
    }
    
    const headers = ["Machine ID", "Parameter", "Value", "Limit", "Timestamp"];
    const rows = globalData.globalAlerts.map(a => [
        `"${a.rig}"`, 
        `"${a.parameter.replace('üö® ', '')}"`, 
        a.value, 
        a.limit, 
        `"${a.date || 'N/A'}"`
    ]);

    const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(r => r.join(",")).join("\n");
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `Fleet_Alert_Report_${new Date().toLocaleDateString()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

let devMode = false;

// üöÄ TRIPLE-CLICK LOGO HANDLER
document.querySelector('.header-left')?.addEventListener('click', function (e) {
    if (e.detail === 3) {
        devMode = !devMode;
        alert(devMode ? "DEV MODE: UNLOCKED" : "DEV MODE: LOCKED");
    }
});

// üîí THE DYNAMIC GUARD
document.addEventListener('contextmenu', e => {
    if (!devMode) e.preventDefault();
});

document.onkeydown = function(e) {
    if (devMode) return true;
    if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) {
        return false;
    }
};
</script>

</body>
</html>







