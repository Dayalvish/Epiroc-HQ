<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EPIROC CENTRAL PARAMETER DASH VIEW</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* =========================================
       1. CORE VARIABLES & GLOBAL RESET
       ========================================= */
    :root { 
        --ey: #f1c40f; 
        --bg: #0d0d0d; 
        --card: #1a1a1a; 
        --red: #ff4d4d; 
        --green: #2ecc71; 
        --blue: #3498db; 
    }
    
    html, body { 
        height: 100%; 
        margin: 0; 
        padding: 0; 
        overflow: hidden; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        background: var(--bg); 
        color: #fff; 
        -webkit-font-smoothing: antialiased;
    }

    /* =========================================
       2. AUTHENTICATION & LOGIN OVERLAY
       ========================================= */
    #login-overlay { 
        position: fixed; 
        inset: 0; 
        background: var(--bg); 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        z-index: 9999; 
    }
    .login-box { 
        background: var(--card); 
        padding: 35px; 
        border-radius: 12px; 
        border-top: 5px solid var(--ey); 
        width: 320px; 
        text-align: center; 
        box-shadow: 0 15px 35px rgba(0,0,0,0.9);
    }
    .login-box input { 
        width: 100%; 
        padding: 12px; 
        margin: 10px 0; 
        background: #222; 
        border: 1px solid #444; 
        color: #fff; 
        border-radius: 4px; 
        box-sizing: border-box; 
    }
    .login-box button { 
        width: 100%; 
        padding: 12px; 
        background: var(--ey); 
        color: #000; 
        border: none; 
        font-weight: bold; 
        border-radius: 4px; 
        cursor: pointer; 
        transition: 0.3s;
    }
    .login-box button:hover { background: #d4ac0d; }

    /* =========================================
       3. DASHBOARD MAIN STRUCTURE
       ========================================= */
    #dashboard-content { 
        display: flex; 
        flex-direction: column; 
        height: 100vh; 
        padding: 12px; 
        box-sizing: border-box; 
        opacity: 0; 
        transition: opacity 0.8s ease-in-out; 
    }
    .authorized #dashboard-content { opacity: 1; pointer-events: auto; }
    .authorized #login-overlay { display: none; }

    /* =========================================
       4. HEADER & NAVIGATION BAR
       ========================================= */
    .header { 
        display: grid; 
        grid-template-columns: 260px 1fr 260px; 
        align-items: center; 
        border-bottom: 2px solid var(--ey); 
        padding-bottom: 8px; 
        margin-bottom: 12px; 
        flex-shrink: 0; 
    }
    .header-left { display: flex; flex-direction: column; align-items: flex-start; }
    .header-center { text-align: center; }
    .header-center h1 { 
        margin: 0; 
        font-size: 1.4rem; 
        letter-spacing: 2px; 
        color: var(--ey); 
        text-transform: uppercase;
    }
    
    .user-badge { 
        background: var(--ey); 
        color: #000; 
        padding: 3px 12px; 
        border-radius: 15px; 
        font-weight: bold; 
        font-size: 0.7rem; 
        margin-top: 5px; 
        display: inline-block; 
    }

    .live-dot { 
        height: 8px; 
        width: 8px; 
        background: var(--green); 
        border-radius: 50%; 
        display: inline-block; 
        margin-right: 6px; 
        animation: pulse 1.5s infinite; 
    }
    @keyframes pulse { 
        0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 
        70% { box-shadow: 0 0 0 8px rgba(46, 204, 113, 0); } 
        100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } 
    }

    /* =========================================
       5. MAIN GRID SYSTEM (3 COLUMNS)
       ========================================= */
    .main-layout { 
        display: grid; 
        grid-template-columns: 260px 1fr 280px; 
        gap: 12px; 
        flex-grow: 1; 
        min-height: 0; 
    }

    .sidebar, .chart-area { 
        background: var(--card); 
        padding: 15px; 
        border-radius: 8px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.6); 
        overflow-y: auto; 
        height: 100%; 
        box-sizing: border-box; 
    }

    /* =========================================
       6. RIGHT SIDEBAR PARTITION (60/40)
       ========================================= */
    .sidebar-right-split { 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        height: 100%; 
    }
    
    .alert-box { 
        flex: 1.6; 
        background: var(--card); 
        padding: 15px; 
        border-radius: 8px; 
        border: 1px solid #333; 
        overflow-y: auto; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    
    .vitals-box { 
        flex: 1; 
        background: var(--card); 
        padding: 15px; 
        border-radius: 8px; 
        border: 1px solid #333; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }

    /* =========================================
       7. HEADERS & COMPONENT TEXT
       ========================================= */
    h3 { 
        font-size: 0.85rem; 
        margin: 0 0 10px 0; 
        border-bottom: 1px solid #333; 
        padding-bottom: 5px; 
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .vital-table { width: 100%; border-collapse: collapse; margin-top: 5px; background: #111; }
    .vital-table td { padding: 8px; border-bottom: 1px solid #222; font-size: 0.9rem; } 
    
    .v-label { color: #888; text-transform: uppercase; font-size: 0.6rem; }
    .v-value { text-align: right; color: var(--ey); font-weight: bold; font-size: 1.05rem; }
    
    .timestamp { 
        font-size: 0.65rem; 
        color: #777; 
        font-style: italic; 
        text-align: left; 
        margin-top: 10px; 
        display: block; 
    }

    /* =========================================
       8. SUMMARY TABLE & CHARTS
       ========================================= */
    .summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #111; font-size: 0.75rem; }
    .summary-table th, .summary-table td { padding: 8px; border: 1px solid #333; text-align: center; }
    .summary-table th { background: #222; color: var(--ey); text-transform: uppercase; position: sticky; top: 0; }

    /* =========================================
       9. INPUTS, SELECTS & MINI-STATS
       ========================================= */
    .mini-stats { margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .mini-card { background: #222; padding: 10px; border-radius: 4px; text-align: center; border: 1px solid #333; }
    .mini-card small { color: #888; display: block; font-size: 0.6rem; margin-bottom: 4px; }
    .mini-card span { font-size: 1.1rem; font-weight: bold; color: var(--ey); }

    select, input { 
        width: 100%; 
        padding: 8px; 
        margin-top: 6px; 
        background: #222; 
        color: #fff; 
        border: 1px solid #444; 
        border-radius: 4px; 
        font-size: 0.85rem; 
        box-sizing: border-box;
    }
    
    input[type="month"] { 
        color: #ffffff !important; 
        color-scheme: dark; 
    }
    
    label { font-size: 0.7rem; color: #888; text-transform: uppercase; display: block; margin-top: 12px; }

    /* =========================================
       10. EXPORT BUTTONS
       ========================================= */
    .btn-red, .btn-green { 
        padding: 8px; 
        border-radius: 4px; 
        font-weight: bold; 
        width: 100%; 
        cursor: pointer; 
        border: none; 
        font-size: 0.75rem; 
        transition: 0.3s;
        text-transform: uppercase;
    }
    .btn-red { background: var(--red); color: white; margin-top: 15px; }
    .btn-green { background: #27ae60; color: white; margin-top: 8px; }
</style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="50">
        <h3>SYSTEM ACCESS</h3>
        <input type="text" id="userIn" placeholder="User ID">
        <input type="password" id="passIn" placeholder="Password">
        <button onclick="handleLogin()">AUTHORIZE ACCESS</button>
        <p id="login-msg" style="color:var(--red); font-size:0.8rem; margin-top:15px;"></p>
    </div>
</div>

<div id="dashboard-content">
    <div id="auditWarning" onclick="this.style.display='none'">
        ‚ö†Ô∏è RIG HAS NOT COVERED MANDATORY MINIMUM AUDITS
    </div>
    
    <div class="header">
        <div class="header-left">
            <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="45">
            <div><span class="live-dot"></span><span id="id-badge" class="user-badge">IDENTIFYING...</span></div>
        </div>
        <div class="header-center">
            <h1>EPIROC CENTRAL PARAMETER DASH VIEW</h1>
            <div style="font-size: 0.8rem; color: #888; margin-top:5px;">LIVE STATUS | <span id="last-sync">--:--:--</span></div>
        </div>
        <div class="header-right"></div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div id="mgmt-city-box" style="display:none; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                <label style="color: var(--ey);">REGION SECTOR</label>
                <select id="cityFocus" onchange="updateRigDropdown()">
                    <option value="All">All India (National)</option>
                    <option value="Ranchi">Ranchi</option>
                    <option value="Hyderabad">Hyderabad</option>
                    <option value="Delhi">Delhi</option>
                    <option value="Nagpur">Nagpur</option>
                    <option value="Udaipur">Udaipur</option>
                    <option value="Kolkata">Kolkata</option>
                </select>
            </div>

            <label>Model Classification</label>
            <select id="modelSelect" onchange="updateRigDropdown()">
                <option value="">All Models</option>
            </select>

            <label>Data View:</label>
            <select id="dataSource" onchange="refresh()">
                <option value="active" selected>Live (Present)</option>
                <option value="history">Archive (Pre-Nov 2025)</option>
            </select>
            
            <label>Target Rig ID</label>
            <select id="rigSelect" onchange="refresh()"><option>Loading...</option></select>
            
            <label>Target Month</label>
            <input type="month" id="monthFilter" onchange="refresh()">

            <label>Analysis Mode</label>
            <select id="chartMode" onchange="drawChart()">
                <option value="tempVsOil">Trend: Temp / Oil / RPM</option>
                <option value="loadVsComp">Load vs Compressor %</option>
                <option value="setBit">DTH: Set vs Bit Pressure</option>
                <option value="hydro_impact">Hydraulic: Impact/Feed/Damper</option>
            </select>

            <div class="mini-stats">
                <div class="mini-card"><small>Fleet Avg Load</small><span id="v-fleet-load">--</span></div>
                <div class="mini-card"><small>Active Assets</small><span id="v-active-rigs">--</span></div>
            </div>

            <button onclick="window.print()" class="btn-red">üìÑ GENERATE PDF</button>
            <button onclick="exportToExcel()" class="btn-green">üìä EXCEL EXPORT</button>
        </div>

        <div class="chart-area">
            <div style="height:350px;"><canvas id="mainChart"></canvas></div>
            <h3 style="color:var(--ey); margin:20px 0 10px 0;">FLEET PERFORMANCE SUMMARY</h3>
            <table class="summary-table" id="summary-tbl">
                <thead>
                    <tr><th rowspan="2">Rig ID</th><th rowspan="2">Audits</th><th colspan="4">Engine Health</th><th colspan="3">Productivity</th></tr>
                    <tr><th>Load %</th><th>Temp ¬∞C</th><th>Oil bar</th><th>Fuel bar</th><th>Air Set</th><th>Bit Pr</th><th>Impact</th></tr>
                </thead>
                <tbody id="fleet-summary-body"></tbody>
            </table>
        </div>

        <div class="sidebar-right-split">
            <div class="alert-box">
                <h3 style="color:var(--red);">‚ö†Ô∏è TRIGGER ALERTS</h3>
                <div id="alert-list">Scanning...</div>
            </div>
            <div class="vitals-box">
                <h3 style="color:var(--ey);">üìä MACHINE VITALS</h3>
                <table class="vital-table">
                    <tr><td class="v-label">Boost Pressure</td><td class="v-value" id="v-boost">--</td></tr>
                    <tr><td class="v-label">Fuel Pressure</td><td class="v-value" id="v-fuel">--</td></tr>
                    <tr><td class="v-label">Receiver PR</td><td class="v-value" id="v-receiver">--</td></tr>
                    <tr><td class="v-label">Hyd-Oil Temp</td><td class="v-value" id="v-temp">--</td></tr>
                </table>
                <div id="vitals-date-stamp" class="timestamp">Data as of: --</div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbyfTF7xgkds2hhOoGIgnYLLmzzuzyw_mRvMiCFl05oYUwdTdBDwP8kMf_D40oEbY357/exec"; 
    let chart = null, globalData = null;

    async function handleLogin() {
        const u = document.getElementById('userIn').value;
        const p = document.getElementById('passIn').value;
        const msg = document.getElementById('login-msg');
        if (!u || !p) { msg.innerText = "Please enter credentials."; return; }
        msg.innerText = "Authenticating...";
        try {
            const resp = await fetch(`${API}?get=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
            const data = await resp.json();
            if (data.success) {
                sessionStorage.setItem('region', data.region);
                sessionStorage.setItem('siteView', data.siteView);
                sessionStorage.setItem('user', u);
                sessionStorage.setItem('logger', data.logger);
                document.getElementById('id-badge').innerText = `${u}-${data.logger}`;
                if(data.role === 'mgmt') document.getElementById('mgmt-city-box').style.display = 'block'; 
                document.body.classList.add('authorized');
                init(); 
            } else { msg.innerText = "Invalid Login."; }
        } catch (e) { msg.innerText = "Connection Failed."; }
    }

    function getFullUrl(params) {
        const r = sessionStorage.getItem('region'), s = sessionStorage.getItem('siteView'), u = sessionStorage.getItem('user');
        return `${API}?${params}&userRegion=${encodeURIComponent(r)}&siteView=${encodeURIComponent(s)}&user=${encodeURIComponent(u)}&v=${Date.now()}`;
    }

    async function init() {
        const now = new Date(); 
        document.getElementById('monthFilter').value = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
        try {
            const mRes = await fetch(getFullUrl("get=model_list"));
            const mList = await mRes.json();
            document.getElementById('modelSelect').innerHTML = '<option value="">All Models</option>' + mList.map(m => `<option value="${m}">${m}</option>`).join('');
            await updateRigDropdown(); 
            if (window.refreshInterval) clearInterval(window.refreshInterval);
            window.refreshInterval = setInterval(() => { refresh(); }, 60000); 
        } catch (e) { console.error("Init Error:", e); }
    }

    async function updateRigDropdown() {
        const model = document.getElementById('modelSelect').value;
        const region = document.getElementById('cityFocus') ? document.getElementById('cityFocus').value : "All";
        const rigSelect = document.getElementById('rigSelect');
        rigSelect.innerHTML = '<option value="">Loading...</option>';
        try {
            const res = await fetch(getFullUrl(`get=list&model=${encodeURIComponent(model)}&userRegion=${encodeURIComponent(region)}`));
            const rigs = await res.json();
            if (rigs && rigs.length > 0) {
                rigSelect.innerHTML = rigs.map((id, index) => `<option value="${id}" ${index === 0 ? 'selected' : ''}>${id}</option>`).join('');
            } else {
                rigSelect.innerHTML = '<option value="">No Rigs Found</option>';
            }
            refresh();
        } catch (e) { console.error("Rig list sync failed:", e); }
    }

    async function refresh() {
        const rig = document.getElementById('rigSelect').value;
        const month = document.getElementById('monthFilter').value; 
        const mode = document.getElementById('dataSource').value; 
        const alertList = document.getElementById('alert-list');
        if (alertList) alertList.innerHTML = "Scanning...";
        try {
            const res = await fetch(getFullUrl(`get=data&rig=${encodeURIComponent(rig)}&month=${month}&mode=${mode}`));
            const data = await res.json();
            globalData = data; 
            updateUI(data);
        } catch (err) { console.error("Refresh Error:", err); }
    }

 // --- UPDATED UI LOGIC WITH TOP BLINKING WARNING & 15s TIMER ---
function updateUI(data) {
    const summaryBody = document.getElementById('fleet-summary-body');
    const warningBox = document.getElementById('auditWarning');
    const rigSelectElem = document.getElementById('rigSelect');
    
    if (data.summary && data.summary.length > 0) {
        const currentDay = new Date().getDate(); // Today is Feb 4th
        const selectedId = rigSelectElem ? rigSelectElem.value.trim().toUpperCase() : "";
        const selectedRigData = data.summary.find(r => String(r.id).trim().toUpperCase() === selectedId);

        // 1. AUDIT LOGIC (Target: 1 per day)
        if (selectedRigData && parseInt(selectedRigData.audits) < currentDay) {
            warningBox.style.display = 'block';
            warningBox.innerHTML = `‚ö†Ô∏è RIG ${selectedId}: ONLY ${selectedRigData.audits}/${currentDay} AUDITS DONE. CLICK TO DISMISS.`;
            
            // Start 15-second auto-hide timer
            if (window.auditTimer) clearTimeout(window.auditTimer);
            window.auditTimer = setTimeout(() => {
                warningBox.style.display = 'none';
            }, 15000);
        } else {
            warningBox.style.display = 'none';
        }

        // 2. HIGHLIGHT SELECTED MACHINE IN SUMMARY TABLE
        summaryBody.innerHTML = data.summary.map(r => {
            const isSelected = String(r.id).trim().toUpperCase() === selectedId;
            return `
                <tr style="${isSelected ? 'background:rgba(241,196,15,0.2); border:1px solid var(--ey);' : ''}">
                    <td><b>${r.id}</b></td>
                    <td style="color:${parseInt(r.audits) < currentDay ? 'var(--red)' : 'var(--green)'}">${r.audits}</td>
                    <td style="color:var(--ey)">${r.avgLoad}%</td>
                    <td>${r.avgTemp}</td>
                    <td>${r.avgOil}</td>
                    <td>${r.avgFuel}</td>
                    <td>${r.avgAir}</td>
                    <td>${r.avgBit}</td>
                    <td>${r.avgImpact}</td>
                </tr>`;
        }).join('');
    }

    // 3. VITALS & ALERTS SYNC
    if (data.vitals) {
        document.getElementById('v-boost').innerText = data.vitals.boost || "0";
        document.getElementById('v-fuel').innerText = data.vitals.fuel || "0";
        document.getElementById('v-receiver').innerText = data.vitals.rec || "0";
        document.getElementById('v-temp').innerText = (data.vitals.hyd || "0") + "¬∞C";
        document.getElementById('vitals-date-stamp').innerText = "Data as of: " + (data.vitals.date || "--");
    }

    const alertList = document.getElementById('alert-list');
    if (alertList) {
        if (data.vitals && data.vitals.alerts && data.vitals.alerts.length > 0) {
            alertList.innerHTML = data.vitals.alerts.map(a => `
                <div style="border-left:4px solid var(--red); background:rgba(255,77,77,0.1); padding:8px; margin-bottom:8px; border-radius:4px;">
                    <b style="color:var(--ey); font-size:0.7rem;">UNIT: ${a.rig}</b><br>
                    <b style="color:var(--red); font-size:0.8rem;">‚ö†Ô∏è ${a.parameter}</b>
                </div>`).join('');
        } else {
            alertList.innerHTML = `<div style="text-align:center; padding:15px; color:var(--green); font-weight:bold;"><span class="live-dot"></span> ALL PARAMETERS NORMAL</div>`;
        }
    }

    // SPONTANEOUS DATA REFRESH
    drawChart();
}

// --- UPDATED CHART LOGIC (Fixed Data Mapping) ---
function drawChart() {
    // STRUCTURE GUARD: Automatically finds the correct data key from API
    const d = globalData?.monthlyData || globalData?.history || globalData?.data || [];
    
    if (d.length === 0) {
        if (chart) chart.destroy(); 
        return;
    }

    const canvas = document.getElementById('mainChart');
    const ctx = canvas.getContext('2d');
    if (chart) chart.destroy();
    
    const mode = document.getElementById('chartMode').value;
    const labels = d.map(x => x.date || x.day || x[0]);
    
    let datasets = [];
    let options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: {
            x: { grid: { color: '#333' }, ticks: { color: '#888' } },
            y: { grid: { color: '#333' }, ticks: { color: '#fff' }, beginAtZero: true }
        }
    };

    if (mode === 'tempVsOil') {
        datasets = [
            { label: 'Oil Pr (bar)', data: d.map(x => x.oil), borderColor: '#2ecc71', yAxisID: 'yOil', tension: 0.3 },
            { label: 'Temp (¬∞C)', data: d.map(x => x.temp), borderColor: '#ff4d4d', yAxisID: 'yTemp', tension: 0.3 },
            { label: 'RPM', data: d.map(x => x.rpm), borderColor: '#3498db', yAxisID: 'yRPM', borderDash: [5, 5], tension: 0.3 }
        ];
        options.scales.yOil = { position: 'left', min: 0, max: 10, ticks: { color: '#2ecc71' } };
        options.scales.yTemp = { position: 'right', min: 40, max: 140, ticks: { color: '#ff4d4d' }, grid: { drawOnChartArea: false } };
        options.scales.yRPM = { position: 'right', display: false }; // Keep RPM visible but clean
    } 
    else if (mode === 'loadVsComp') {
        datasets = [
            { label: 'Engine Load %', data: d.map(x => x.load), borderColor: '#f1c40f', tension: 0.3, fill: true, backgroundColor: 'rgba(241,196,15,0.1)' },
            { label: 'Compressor %', data: d.map(x => x.comp), borderColor: '#3498db', tension: 0.3 }
        ];
    } 
    else if (mode === 'setBit') {
        datasets = [
            { label: 'Air Set (bar)', data: d.map(x => x.air), borderColor: '#2ecc71', tension: 0.3 },
            { label: 'Bit Pr (bar)', data: d.map(x => x.bit), borderColor: '#3498db', tension: 0.3 }
        ];
    } 
    else if (mode === 'hydro_impact') {
        datasets = [
            { label: 'Impact (bar)', data: d.map(x => x.impact || x.imp), borderColor: '#f1c40f', tension: 0.3 },
            { label: 'Feed (bar)', data: d.map(x => x.feed || x.fd), borderColor: '#e67e22', tension: 0.3 },
            { label: 'Damper (bar)', data: d.map(x => x.damper || x.dmp), borderColor: '#3498db', tension: 0.3 }
        ];
    }

    chart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: options });
}
    function exportToExcel() {
        const table = document.getElementById("summary-tbl");
        const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
        const link = document.createElement('a');
        link.download = "Report.xls"; link.href = url; link.click();
    }

    window.onload = function() {
        const now = new Date();
        const mFilter = document.getElementById('monthFilter');
        if (mFilter) mFilter.value = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
    };
</script>
</body>
</html>





