<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EPIROC CENTRAL PARAMETER DASH VIEW</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <style>
    :root { --ey:#f1c40f; --bg:#0d0d0d; --card:#1a1a1a; --red:#ff4d4d; --green:#2ecc71; --blue:#3498db; }
    html, body { height:100%; margin:0; padding:0; overflow:hidden; font-family:'Segoe UI',sans-serif; background:var(--bg); color:#fff; -webkit-font-smoothing:antialiased; }

    /* AUTH & LAYOUT */
    #login-overlay { position:fixed; inset:0; background:var(--bg); display:flex; justify-content:center; align-items:center; z-index:9999; }
    .login-box { background:var(--card); padding:35px; border-radius:12px; border-top:5px solid var(--ey); width:320px; text-align:center; box-shadow:0 15px 35px rgba(0,0,0,0.9); }
    #dashboard-content { display:flex; flex-direction:column; height:100vh; padding:12px; box-sizing:border-box; opacity:0; transition:opacity 0.8s; }
    .authorized #dashboard-content { opacity:1; pointer-events:auto; }
    .authorized #login-overlay { display:none; }

    /* HEADER & GRID */
    .header { display:grid; grid-template-columns:260px 1fr 260px; align-items:center; border-bottom:2px solid var(--ey); padding-bottom:8px; margin-bottom:12px; flex-shrink:0; }
    .header-center h1 { margin:0; font-size:1.4rem; letter-spacing:2px; color:var(--ey); text-transform:uppercase; text-align:center; }
    .main-layout { display:grid; grid-template-columns:260px 1fr 280px; gap:12px; flex-grow:1; min-height:0; }
    .sidebar, .chart-area, .alert-box, .vitals-box { background:var(--card); padding:15px; border-radius:8px; border:1px solid #333; box-shadow:0 4px 15px rgba(0,0,0,0.4); overflow-y:auto; box-sizing:border-box; }
    .sidebar-right-split { display:flex; flex-direction:column; gap:12px; height:100%; }
    .alert-box { flex:1.6; } .vitals-box { flex:1; }

    /* TABLES & DATA */
    h3 { font-size:0.85rem; margin:0 0 10px 0; border-bottom:1px solid #333; padding-bottom:5px; color:#fff; text-transform:uppercase; }
    .summary-table, .vital-table { width:100%; border-collapse:collapse; }
    .summary-table { margin-top:15px; background:#111; font-size:0.75rem; }
    .summary-table th, .summary-table td { padding:8px; border:1px solid #333; text-align:center; }
    .summary-table th { background:#222; color:var(--ey); position:sticky; top:0; }
    
    .vital-table td { padding:10px 5px; border-bottom:1px solid #222; font-size:1rem; }
    .v-label { color:#888; font-size:0.65rem; text-transform:uppercase; }
    .v-value { text-align:right; color:var(--ey); font-weight:bold; font-size:1.4rem; padding-right:15px; }
    .timestamp { font-size:0.7rem; color:#888; text-align:left!important; margin-top:10px; display:block; }

    /* FORM ELEMENTS & MINI STATS */
    select, input { width:100%; padding:8px; margin-top:6px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; font-size:0.85rem; }
    input[type="month"] { color-scheme:dark; }
    .mini-stats { margin-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .mini-card { background:#222; padding:10px; border-radius:4px; text-align:center; border:1px solid #333; }
    .mini-card span { font-size:1.1rem; font-weight:bold; color:var(--ey); }
    
    .btn-red, .btn-green { padding:8px; border-radius:4px; font-weight:bold; width:48%; cursor:pointer; border:none; font-size:0.7rem; text-transform:uppercase; margin-top:15px; display:inline-block; }
    .btn-red { background:var(--red); color:#fff; } .btn-green { background:var(--green); color:#fff; }

    #auditWarning { display:none; position:fixed; top:15%; left:50%; transform:translateX(-50%); background:var(--red); color:#fff; padding:12px 30px; border-radius:8px; z-index:10000; animation:blinker 1s linear infinite; }
    @keyframes blinker { 50% { opacity:0.6; } }
</style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="50">
        <h3>SYSTEM ACCESS</h3>
        <input type="text" id="userIn" placeholder="User ID">
        <input type="password" id="passIn" placeholder="Password">
        <button onclick="handleLogin()">AUTHORIZE ACCESS</button>
        <p id="login-msg" style="color:var(--red); font-size:0.8rem; margin-top:15px;"></p>
    </div>
</div>

<div id="dashboard-content">
    <div id="auditWarning" onclick="this.style.display='none'" title="Click to dismiss">
    ‚ö†Ô∏è RIG HAS NOT COVERED MANDATORY MINIMUM AUDITS
</div>
    
    <div class="header">
        <div class="header-left">
            <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="45">
            <div><span class="live-dot"></span><span id="id-badge" class="user-badge">IDENTIFYING...</span></div>
        </div>
        <div class="header-center">
            <h1>EPIROC CENTRAL PARAMETER DASH VIEW</h1>
            <div style="font-size: 0.8rem; color: #888; margin-top:5px;">LIVE STATUS | <span id="last-sync">--:--:--</span></div>
        </div>
        <div class="header-right"></div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div class="filter-group" id="mgmt-city-box" style="display:none; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label style="color: var(--ey); font-size: 0.85rem;">REGION SECTOR</label>
                    <button onclick="resetCityFilter()" style="background: none; border: 1px solid var(--ey); color: var(--ey); font-size: 0.65rem; padding: 2px 6px; cursor: pointer; border-radius: 3px;">RESET</button>
                </div>
                <select id="cityFocus" onchange="applyGlobalFilters()">
                    <option value="All">All India (National)</option>
                    <option value="Ranchi">Ranchi</option>
                    <option value="Hyderabad">Hyderabad</option>
                    <option value="Delhi">Delhi</option>
                    <option value="Nagpur">Nagpur</option>
                    <option value="Udaipur">Udaipur</option>
                    <option value="Kolkata">Kolkata</option>
                </select>
            </div>

            <label>Model Classification</label>
<select id="modelSelect" onchange="applyGlobalFilters()">
    <option value="">All Models</option>
</select>

            <div class="filter-group" style="margin-top:15px;">
                <label for="dataSource">Data View:</label>
                <select id="dataSource" onchange="refresh()">
                    <option value="active" selected>Live (Present)</option>
                    <option value="history">Archive (Pre-Nov 2025)</option>
                </select>
            </div>
            
            <label style="display:block; margin-top:15px;">Target Rig ID</label>
            <select id="rigSelect" onchange="refresh()"><option>Loading...</option></select>
            
            <label style="display:block; margin-top:15px;">Target Month</label>
            <input type="month" id="monthFilter" onchange="refresh()">

            <label style="display:block; margin-top:15px;">Analysis Mode</label>
            <select id="chartMode" onchange="drawChart()">
                <option value="tempVsOil">Trend: Temp / Oil / RPM</option>
                <option value="loadVsComp">Load vs Compressor %</option>
                <option value="setBit">DTH: Set vs Bit Pressure</option>
                <option value="hydro_impact">Hydraulic: Impact/Feed/Damper</option>
            </select>

            <div class="mini-stats">
                <div class="mini-card"><small>Fleet Avg Load</small><span id="v-fleet-load">--</span></div>
                <div class="mini-card"><small>Active Assets</small><span id="v-active-rigs">--</span></div>
            </div>

            <button onclick="window.print()" class="btn-red">üìÑ GENERATE PDF</button>
            <button onclick="exportToExcel()" class="btn-green">üìä EXCEL EXPORT</button>
        </div>

        <div class="chart-area">
    <div style="height:350px;"><canvas id="mainChart"></canvas></div>
    <h3 style="color:var(--ey); margin:30px 0 10px 0;">FLEET PERFORMANCE SUMMARY</h3>
    <table class="summary-table" id="summary-tbl">
        <thead>
            <tr><th rowspan="2">Rig ID</th><th rowspan="2">Audits</th><th colspan="4">Engine Health</th><th colspan="3">Productivity</th></tr>
            <tr><th>Load %</th><th>Temp ¬∞C</th><th>Oil bar</th><th>Fuel bar</th><th>Air Set</th><th>Bit Pr</th><th>Impact</th></tr>
        </thead>
        <tbody id="fleet-summary-body"></tbody>
    </table>
</div>

<div class="sidebar-right-split">
    <div class="alert-box">
        <h3 style="color:var(--red); margin-top:0; border-bottom: 1px solid #333; padding-bottom: 10px;">‚ö†Ô∏è TRIGGER ALERTS</h3>
        <div id="alert-list">Scanning...</div>
    </div>

    <div class="vitals-box">
        <h3 style="color:var(--ey); margin-top:0; border-bottom: 1px solid #333; padding-bottom: 10px;">üìä MACHINE VITALS</h3>
        <table class="vital-table">
            <tr><td class="v-label">Boost Pressure</td><td class="v-value" id="v-boost">--</td></tr>
            <tr><td class="v-label">Fuel Pressure</td><td class="v-value" id="v-fuel">--</td></tr>
            <tr><td class="v-label">Receiver PR</td><td class="v-value" id="v-receiver">--</td></tr>
            <tr><td class="v-label">Hyd-Oil Temp</td><td class="v-value" id="v-temp">--</td></tr>
        </table>
        <div id="vitals-date-stamp" class="timestamp" style="font-size: 0.7rem; color: #666; text-align: right; margin-top: 10px;">Data as of: --</div>
    </div>
</div> </div> </div> ```
<script>
    const API = "https://script.google.com/macros/s/AKfycbyfTF7xgkds2hhOoGIgnYLLmzzuzyw_mRvMiCFl05oYUwdTdBDwP8kMf_D40oEbY357/exec"; 
    let chart = null, globalData = null;

    // --- 1. LOGIN & AUTH ---
    async function handleLogin() {
        const u = document.getElementById('userIn').value;
        const p = document.getElementById('passIn').value;
        const msg = document.getElementById('login-msg');
        
        if (!u || !p) { msg.innerText = "Please enter credentials."; return; }
        msg.innerText = "Authenticating...";
        
        try {
            const resp = await fetch(`${API}?get=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
            const data = await resp.json();
            if (data.success) {
                sessionStorage.setItem('region', data.region);
                sessionStorage.setItem('siteView', data.siteView);
                sessionStorage.setItem('user', u);
                sessionStorage.setItem('logger', data.logger);
                document.getElementById('id-badge').innerText = `${u}-${data.logger}`;
                
                if(data.role === 'mgmt') { 
                    document.getElementById('mgmt-city-box').style.display = 'block'; 
                }
                
                document.body.classList.add('authorized');
                init(); 
            } else { msg.innerText = "Invalid Login."; }
        } catch (e) { msg.innerText = "Connection Failed."; }
    }

    function getFullUrl(params) {
        const r = sessionStorage.getItem('region'), s = sessionStorage.getItem('siteView'), u = sessionStorage.getItem('user');
        return `${API}?${params}&userRegion=${encodeURIComponent(r)}&siteView=${encodeURIComponent(s)}&user=${encodeURIComponent(u)}&v=${Date.now()}`;
    }

    // --- 2. INITIALIZATION ---
    async function init() {
        const now = new Date(); 
        document.getElementById('monthFilter').value = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
        try {
            const mRes = await fetch(getFullUrl("get=model_list"));
            const mList = await mRes.json();
            document.getElementById('modelSelect').innerHTML = '<option value="">All Models</option>' + mList.map(m => `<option value="${m}">${m}</option>`).join('');
            
            await updateRigDropdown(); 
            
            if (window.refreshInterval) clearInterval(window.refreshInterval);
            window.refreshInterval = setInterval(() => { refresh(); }, 60000); 
        } catch (e) { console.error("Init Error:", e); }
    }

    // --- 3. DROPDOWN & DATA REFRESH ---
   async function updateRigDropdown() {
    const model = document.getElementById('modelSelect').value;
    const rigSelect = document.getElementById('rigSelect');
    
    // 1. Clear current options and show a loading state
    rigSelect.innerHTML = '<option value="">Loading Rigs...</option>';
    
    try {
        // 2. Fetch the filtered list from your GS Part 4 (list handler)
        const res = await fetch(getFullUrl(`get=list&model=${encodeURIComponent(model)}`));
        const rigs = await res.json();
        
        // 3. Populate the dropdown. 
        // Use the first rig in the list as the default to avoid a blank start.
        if (rigs && rigs.length > 0) {
            rigSelect.innerHTML = rigs.map((id, index) => 
                `<option value="${id}" ${index === 0 ? 'selected' : ''}>${id}</option>`
            ).join('');
        } else {
            rigSelect.innerHTML = '<option value="">No Rigs Found</option>';
        }
        
        // 4. Immediately trigger a refresh to update Vitals and Charts for the new first rig
        refresh();
    } catch (e) {
        console.error("Rig list sync failed:", e);
        rigSelect.innerHTML = '<option value="">Error Loading</option>';
    }
}

  async function refresh() {
    const rig = document.getElementById('rigSelect').value;
    const month = document.getElementById('monthFilter').value; 
    const mode = document.getElementById('dataSource').value; 
    
    const alertList = document.getElementById('alert-list');
    if (alertList) alertList.innerHTML = "Scanning...";

    try {
        const url = getFullUrl(`get=data&rig=${encodeURIComponent(rig)}&month=${month}&mode=${mode}`);
        const res = await fetch(url);
        const json = await res.json();
        
        // CRITICAL FIX: Ensure we are passing an ARRAY to updateUI
        const dataArray = Array.isArray(json) ? json : (json.data || json.fleet || []);
        
        if (dataArray.length === 0) {
            if (alertList) alertList.innerHTML = "<span style='color:var(--ey)'>No data found.</span>";
            return;
        }

        globalData = json; // Keep the full object for the chart
        updateUI(dataArray); // Pass the clean list to the UI
        
    } catch (err) { 
        console.error("Fetch Error:", err); 
        if (alertList) alertList.innerHTML = "<span style='color:red'>Connection Error</span>";
    }
}
function updateUI(data) {
    try {
        const summaryBody = document.getElementById('fleet-summary-body');
        const rigSelectElem = document.getElementById('rigSelect');
        const alertList = document.getElementById('alert-list');
        
        if (!data || data.length === 0) return;

        // SAFE DATA MATCHING: Checks both 'rig_id' and 'RigID'
        const selectedId = rigSelectElem ? rigSelectElem.value : "";
        let rigData = data.find(r => 
            String(r.rig_id || r.RigID || "").toLowerCase() === String(selectedId).toLowerCase()
        );

        // FALLBACK: If no match, take the first rig so the screen isn't blank
        if (!rigData) rigData = data[0];

        // 1. DYNAMIC AUDIT LOGIC (The Pro-Rata 1-per-day fix)
        checkAuditProgress(rigData);

        // 2. RE-POPULATE SUMMARY TABLE (Restored this missing section)
        if (summaryBody) {
            const currentDay = new Date().getDate();
            summaryBody.innerHTML = data.map(r => `
                <tr data-region="${r.region || ''}" data-model="${r.model || ''}">
                    <td>${r.rig_id || r.RigID}</td>
                    <td style="color:${parseInt(r.audits || 0) < currentDay ? 'var(--red)' : 'var(--green)'}">${r.audits || 0}</td>
                    <td>${r.load || 0}%</td>
                    <td>${r.temp || 0}¬∞C</td>
                    <td>${r.oil || 0}</td>
                    <td>${r.fuel || 0}</td>
                    <td>${r.air || 0}</td>
                    <td>${r.bit || 0}</td>
                    <td>${r.impact || 0}</td>
                </tr>
            `).join('');
        }

        // 3. UPDATE VITALS
        const safeSet = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.innerText = val !== undefined && val !== null ? val : "--";
        };

        safeSet('v-boost', rigData.boost);
        safeSet('v-fuel', rigData.fuel);
        safeSet('v-receiver', rigData.rec || rigData.receiver);
        
        const tEl = document.getElementById('v-temp');
        if (tEl) tEl.innerText = (rigData.temp || rigData.hyd || "--") + "¬∞C";

        const dEl = document.getElementById('vitals-date-stamp');
        if (dEl) dEl.innerText = "Data as of: " + (rigData.date || "--");

        // 4. ALERTS (STOP SCANNING)
        if (alertList) {
            if (rigData.alerts && Array.isArray(rigData.alerts) && rigData.alerts.length > 0) {
                alertList.innerHTML = rigData.alerts.map(a => `
                    <div style="border-left:4px solid var(--red); background:rgba(255,77,77,0.1); padding:8px; margin-bottom:8px; border-radius:4px;">
                        <b style="color:var(--ey); font-size:0.7rem;">UNIT: ${a.rig || rigData.rig_id}</b><br>
                        <b style="color:var(--red); font-size:0.8rem;">‚ö†Ô∏è ${a.parameter}</b>
                    </div>`).join('');
            } else {
                alertList.innerHTML = `<div style="text-align:center; padding:15px; color:var(--green); font-weight:bold;"><span class="live-dot"></span> ALL PARAMETERS NORMAL</div>`;
            }
        }
        
        // 5. UPDATE MINI STATS
        const avgL = data.reduce((s, c) => s + parseFloat(c.load || 0), 0) / data.length;
        safeSet('v-fleet-load', avgL.toFixed(1) + "%");
        safeSet('v-active-rigs', data.length);

        // 6. REDRAW CHART
        drawChart();

    } catch (err) {
        console.error("UI Update Error:", err);
    }
} // FIXED: Added missing closing brace here
function checkAuditProgress(rigData) {
    const now = new Date();
    const currentDay = now.getDate(); // Today's date (e.g., 4th Feb)
    const auditsDone = parseInt(rigData.audits || 0);
    const warningEl = document.getElementById('auditWarning');
    
    if (!warningEl) return;

    // TARGET: 1 Audit per day. If today is the 4th, target is 4.
    if (auditsDone < currentDay) {
        warningEl.style.display = 'block';
        warningEl.innerHTML = `‚ö†Ô∏è RIG ${rigData.rig_id || 'ID'}: ${auditsDone}/${currentDay} AUDITS DONE (Required: 1 Per Day)`;
        
        // Red if > 2 days behind, Orange if 1-2 days behind
        warningEl.style.background = (currentDay - auditsDone > 2) ? 'var(--red)' : '#e67e22';
    } else {
        warningEl.style.display = 'none';
    }
}

// 5. SAFE FILTERING FUNCTION
function applyGlobalFilters() {
    const cityElem = document.getElementById('cityFocus');
    const selRegion = cityElem ? cityElem.value : "All";
    const selModel = document.getElementById('modelSelect').value;
    const rows = document.querySelectorAll('#fleet-summary-body tr');
    
    let visibleCount = 0;
    let totalLoad = 0;

    rows.forEach(row => {
        const rReg = row.getAttribute('data-region') || "";
        const rMod = row.getAttribute('data-model') || "";

        const regionMatch = (selRegion === "All India (National)" || selRegion === "All" || rReg === selRegion);
        const modelMatch = (selModel === "" || rMod === selModel);

        if (regionMatch && modelMatch) {
            row.style.display = ""; 
            visibleCount++;
            const loadVal = parseFloat(row.cells[2].innerText.replace('%', '')) || 0;
            totalLoad += loadVal;
        } else {
            row.style.display = "none"; 
        }
    });

    document.getElementById('v-active-rigs').innerText = visibleCount;
    document.getElementById('v-fleet-load').innerText = visibleCount > 0 ? (totalLoad / visibleCount).toFixed(1) + "%" : "0%";
}
    // --- 6. ANALYTICAL CHARTING & EXPORT ---
   function drawChart() {
    if (!globalData || !globalData.monthlyData || globalData.monthlyData.length === 0) {
        if (chart) chart.destroy(); 
        return;
    }

    const canvas = document.getElementById('mainChart');
    const ctx = canvas.getContext('2d');
    if (chart) chart.destroy();
    
    const mode = document.getElementById('chartMode').value;
    const d = globalData.monthlyData;
    const labels = d.map(x => x.date);
    
    let datasets = [];
    let options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: {
            x: { grid: { color: '#333' }, ticks: { color: '#888' } },
            y: { grid: { color: '#333' }, ticks: { color: '#fff' } }
        }
    };

    if (mode === 'tempVsOil') {
        // Triple Axis Mode
        datasets = [
            { label: 'Oil Pr (bar)', data: d.map(x => x.oil), borderColor: '#2ecc71', yAxisID: 'yOil', tension: 0.3 },
            { label: 'Temp (¬∞C)', data: d.map(x => x.temp), borderColor: '#ff4d4d', yAxisID: 'yTemp', tension: 0.3 },
            { label: 'RPM', data: d.map(x => x.rpm), borderColor: '#3498db', yAxisID: 'yRPM', borderDash: [5, 5], tension: 0.3 }
        ];
        options.scales.yOil = { position: 'left', min: 0, max: 8, ticks: { stepSize: 0.2, color: '#2ecc71' } };
        options.scales.yTemp = { position: 'right', min: 60, max: 130, ticks: { stepSize: 3, color: '#ff4d4d' }, grid: { drawOnChartArea: false } };
        options.scales.yRPM = { position: 'right', min: 600, max: 2200, ticks: { stepSize: 25, color: '#3498db' }, grid: { drawOnChartArea: false } };
    } 
    else if (mode === 'loadVsComp') {
        datasets = [
            { label: 'Engine Load %', data: d.map(x => x.load), borderColor: '#f1c40f', tension: 0.3 },
            { label: 'Compressor %', data: d.map(x => x.comp), borderColor: '#3498db', tension: 0.3 }
        ];
        options.scales.y.max = 100;
    } 
    else if (mode === 'setBit') {
        datasets = [
            { label: 'Air Set (bar)', data: d.map(x => x.air), borderColor: '#2ecc71', tension: 0.3 },
            { label: 'Bit Pr (bar)', data: d.map(x => x.bit), borderColor: '#3498db', tension: 0.3 }
        ];
    } 
    else if (mode === 'hydro_impact') {
        datasets = [
            { label: 'Impact (bar)', data: d.map(x => x.impact), borderColor: '#f1c40f', tension: 0.3 },
            { label: 'Feed (bar)', data: d.map(x => x.feed), borderColor: '#e67e22', tension: 0.3 },
            { label: 'Damper (bar)', data: d.map(x => x.damper), borderColor: '#3498db', tension: 0.3 }
        ];
    }

    chart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: options });
}
    function exportToExcel() {
        let table = document.getElementById("summary-tbl");
        let url = 'data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
        let link = document.createElement('a'); 
        link.download = "Fleet_Performance_Report.xls"; 
        link.href = url; 
        link.click();
    }
    // Function 1: Updates Models based on selected Region
async function updateModelDropdown() {
    const region = document.getElementById('cityFocus').value;
    const modelSelect = document.getElementById('modelSelect');
    
    // Fetch only models active in this region
    const res = await fetch(getFullUrl(`get=model_list&userRegion=${encodeURIComponent(region)}`));
    const models = await res.json();
    
    // Repopulate Model Dropdown
    modelSelect.innerHTML = '<option value="">All Models</option>' + 
        models.map(m => `<option value="${m}">${m}</option>`).join('');
        
    // Cascade to update the Rig list immediately
    updateRigDropdown();
}

// Function 2: Updates Rigs based on both Region and Model
async function updateRigDropdown() {
    const region = document.getElementById('cityFocus').value;
    const model = document.getElementById('modelSelect').value;
    const rigSelect = document.getElementById('rigSelect');
    
    // Show loading to avoid "Blank" state
    rigSelect.innerHTML = '<option value="">Loading...</option>';
    
    const res = await fetch(getFullUrl(`get=list&userRegion=${encodeURIComponent(region)}&model=${encodeURIComponent(model)}`));
    const rigs = await res.json();
    
    // Repopulate Rig Dropdown and select the first index
    if (rigs && rigs.length > 0) {
        rigSelect.innerHTML = rigs.map((id, index) => 
            `<option value="${id}" ${index === 0 ? 'selected' : ''}>${id}</option>`
        ).join('');
    } else {
        rigSelect.innerHTML = '<option value="">No Rigs Found</option>';
    }
    
    // Trigger refresh to update the table and charts for the new selection
    refresh();
}
    // ADD THIS AT THE VERY BOTTOM OF YOUR SCRIPT TAG
window.onload = function() {
    const now = new Date();
    const mFilter = document.getElementById('monthFilter');
    if (mFilter) {
        // Sets the default month so the first fetch isn't empty
        mFilter.value = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
    }
    // If already authorized (page refresh), start the init
    if (document.body.classList.contains('authorized')) {
        init();
    }
}
</script>
</body>
</html>












