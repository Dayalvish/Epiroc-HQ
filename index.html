<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Epiroc Fleet Visualizer - Production</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0b0b0b; --panel: #141414; --gold: #f1c40f; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Styles */
        #sidebar { width: 280px; background: var(--panel); border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--gold); margin-bottom: 25px; text-align: center; }
        select, input { width: 100%; padding: 10px; background: #222; color: #fff; border: 1px solid #444; margin-bottom: 15px; border-radius: 4px; }
        
        /* Vital Table Styles */
        .section-title { color: var(--gold); font-size: 0.9rem; margin: 15px 0 5px 0; border-bottom: 1px solid #333; padding-bottom: 3px; }
        .vital-table { width: 100%; border-collapse: collapse; background: #1a1a1a; }
        .vital-table td { padding: 8px; border-bottom: 1px solid #222; font-size: 0.85rem; color: #ccc; }
        .vital-val { text-align: right; color: var(--gold) !important; font-weight: bold; }

        /* Warning Popup */
        .warning-popup {
            display: none; position: fixed; top: 15%; left: 50%; transform: translateX(-50%);
            background: #e74c3c; color: white; padding: 15px 30px; border-radius: 8px;
            font-weight: bold; z-index: 10000; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation: blinker 0.8s linear infinite;
        }
        @keyframes blinker { 50% { opacity: 0; } }

        /* Main Content */
        #main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .chart-container { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid #222; flex: 1; min-height: 350px; }
        .summary-box { background: var(--panel); border-radius: 8px; padding: 15px; }
        table.fleet-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        table.fleet-table th { background: #222; color: var(--gold); text-align: left; padding: 10px; }
        table.fleet-table td { padding: 8px; border-bottom: 1px solid #222; }

        /* Overlays */
        #loginScreen { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 10001; }
        .login-box { background: #141414; padding: 40px; border-radius: 12px; border: 1px solid var(--gold); width: 320px; }
        #loader { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <div class="logo">EPIROC ACCESS</div>
            <input type="text" id="user" placeholder="Username">
            <input type="password" id="pass" placeholder="Password">
            <button onclick="login()" style="width:100%; padding:10px; background:var(--gold); border:none; font-weight:bold; cursor:pointer;">LOGIN</button>
        </div>
    </div>

    <div id="loader">üîÑ FETCHING RIG DATA...</div>
    <div id="auditWarning" class="warning-popup">‚ö†Ô∏è Rig Has not covered mandatory minimum Audits</div>

    <aside id="sidebar">
        <div class="logo">EPIROC VIZ</div>
        <div id="badge" style="font-size: 0.8rem; text-align: center; margin-bottom: 20px; color: #888;"></div>
        
        <label>Month</label>
        <input type="month" id="targetMonth" onchange="loadFleetSummary()">

        <label>Model Classification</label>
        <select id="modelSelect" onchange="loadRigList()"><option>Loading...</option></select>

        <label>Target Rig ID</label>
        <select id="rigSelect" onchange="loadRigDetails()"><option>Select Model First</option></select>

        <div class="vital-section">
            <h3 class="section-title">VITAL DATA</h3>
            <table class="vital-table">
                <tr><td>Boost Pressure</td><td id="vBoost" class="vital-val">--</td></tr>
                <tr><td>Fuel Pressure</td><td id="vFuel" class="vital-val">--</td></tr>
                <tr><td>Receiver Pr</td><td id="vReceiver" class="vital-val">--</td></tr>
                <tr><td>Hyd-Oil Temp</td><td id="vHydTemp" class="vital-val">--</td></tr>
            </table>
        </div>
    </aside>

    <main id="main">
        <div class="chart-container">
            <select id="analysisMode" onchange="loadRigDetails()" style="width: 250px; float: right;">
                <option value="engine_temp">Engine: Temp & RPM</option>
                <option value="load_comp">Load vs Compressor %</option>
                <option value="hydro_impact">Hydraulic: Impact/Feed/Damper</option>
            </select>
            <canvas id="mainChart"></canvas>
        </div>
        <div class="summary-box">
            <h3 style="color:var(--gold); margin-top:0;">Fleet Performance Summary</h3>
            <div style="overflow-x: auto;">
                <table class="fleet-table" id="summaryTable">
                    <thead>
                        <tr>
                            <th>Rig ID</th><th>Audits</th><th>Avg Load</th><th>Avg Temp</th><th>Avg Fuel</th><th>Avg Bit</th><th>Avg Impact</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbyp-cUeZm1LeFQ6pkYsmfI2EKQAVxFw16NCBNE24B22L_USeEBIMfEbRgtv5KK2LhZM/exec";
        let session = {};
        let myChart = null;

        async function login() {
            const user = document.getElementById('user').value;
            const pass = document.getElementById('pass').value;
            const res = await fetch(`${API}?get=login&user=${user}&pass=${pass}`);
            const data = await res.json();
            if(data.success) {
                session = data;
                session.username = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('badge').innerText = `Logged in as: ${data.logger}`;
                initDashboard();
            } else { alert("Invalid Credentials"); }
        }

        function initDashboard() {
            const today = new Date();
            const month = today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('targetMonth').value = month;
            loadModels();
            loadFleetSummary();
        }

        async function loadModels() {
            const res = await fetch(`${API}?get=model_list&userRegion=${session.region}&siteView=${session.siteView}&user=${session.username}`);
            const models = await res.json();
            let html = '<option value="All Models">All Models</option>';
            models.forEach(m => html += `<option value="${m}">${m}</option>`);
            document.getElementById('modelSelect').innerHTML = html;
        }

        async function loadRigList() {
            const model = document.getElementById('modelSelect').value;
            const res = await fetch(`${API}?get=list&model=${model}&userRegion=${session.region}&siteView=${session.siteView}&user=${session.username}`);
            const rigs = await res.json();
            let html = '<option value="">Select Rig</option>';
            rigs.forEach(r => html += `<option value="${r}">${r}</option>`);
            document.getElementById('rigSelect').innerHTML = html;
        }

        async function loadFleetSummary() {
            document.getElementById('loader').style.display = 'flex';
            const month = document.getElementById('targetMonth').value;
            const model = document.getElementById('modelSelect').value;
            const res = await fetch(`${API}?get=fleet_summary&month=${month}&model=${model}&userRegion=${session.region}&siteView=${session.siteView}&user=${session.username}`);
            const data = await res.json();
            
            let html = '';
            data.forEach(r => {
                html += `<tr>
                    <td>${r.id}</td><td>${r.monthlyAudits}</td><td>${r.avgLoad}%</td>
                    <td>${r.avgTemp}¬∞C</td><td>${r.avgFuel} l/h</td><td>${r.avgBitPr} bar</td><td>${r.avgImpact} bar</td>
                </tr>`;
            });
            document.getElementById('summaryTable').querySelector('tbody').innerHTML = html;
            document.getElementById('loader').style.display = 'none';
        }

        async function loadRigDetails() {
            const rig = document.getElementById('rigSelect').value;
            if(!rig) return;
            document.getElementById('loader').style.display = 'flex';
            const month = document.getElementById('targetMonth').value;
            const res = await fetch(`${API}?get=details&fleetId=${rig}&month=${month}&userRegion=${session.region}&siteView=${session.siteView}&user=${session.username}`);
            const data = await res.json();

            // Vital Data Table
            if(data.vitals) {
                document.getElementById('vBoost').innerText = data.vitals.boostPr;
                document.getElementById('vFuel').innerText = data.vitals.fuelPr;
                document.getElementById('vReceiver').innerText = data.vitals.receiverPr;
                document.getElementById('vHydTemp').innerText = data.vitals.hydOilTemp + "¬∞C";
            }

            // Audit Warning
            const warning = document.getElementById('auditWarning');
            if(data.monthlyAuditCount < 15) {
                warning.style.display = 'block';
                setTimeout(() => warning.style.display = 'none', 30000);
            } else { warning.style.display = 'none'; }

            drawChart(data.monthlyData);
            document.getElementById('loader').style.display = 'none';
        }

        function drawChart(rows) {
            const mode = document.getElementById('analysisMode').value;
            const labels = rows.map(r => r.date);
            let datasets = [];

            if(mode === 'engine_temp') {
                datasets = [
                    { label: 'RPM', data: rows.map(r => r.engRpm), borderColor: '#f1c40f', yAxisID: 'y' },
                    { label: 'Temp', data: rows.map(r => r.engTemp), borderColor: '#e74c3c', yAxisID: 'y1' }
                ];
            } else if(mode === 'load_comp') {
                datasets = [
                    { label: 'Load %', data: rows.map(r => r.engLoad), borderColor: '#2ecc71' },
                    { label: 'Compressor %', data: rows.map(r => r.compPerc), borderColor: '#3498db' }
                ];
            } else if(mode === 'hydro_impact') {
                datasets = [
                    { label: 'Impact', data: rows.map(r => r.highImpact), borderColor: '#f1c40f' },
                    { label: 'Feed', data: rows.map(r => r.feedPrHigh), borderColor: '#e67e22' },
                    { label: 'Damper', data: rows.map(r => r.damperPrHigh), borderColor: '#3498db' }
                ];
            }

            if(myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { y1: { position: 'right', grid: { display: false } } } }
            });
        }
    </script>
</body>
</html>
