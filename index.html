<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EPIROC CENTRAL VISUALIZER</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0b0b0b; --panel: #141414; --gold: #f1c40f; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; }
        
        /* Login Screen */
        #loginScreen { position: fixed; inset: 0; background: #000; z-index: 20000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: var(--panel); padding: 40px; border-radius: 12px; border: 1px solid var(--gold); width: 300px; text-align: center; }
        
        #sidebar { width: 280px; background: var(--panel); border-right: 1px solid #333; padding: 20px; overflow-y: auto; }
        #main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; position: relative; }

        /* Threshold Warning Box (Right) */
        #thresholdBox {
            position: absolute; right: 20px; top: 20px; width: 240px;
            background: rgba(20, 20, 20, 0.9); border: 1px solid #444; border-radius: 8px;
            padding: 15px; z-index: 100; display: none;
        }
        .thresh-line { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; }

        /* General Styles */
        .vital-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .vital-table td { padding: 8px 0; border-bottom: 1px solid #222; font-size: 0.85rem; color: #bbb; }
        .vital-val { text-align: right; color: var(--gold); font-weight: bold; }
        input, select, button { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff; }
        .warning-popup { display: none; position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: #e74c3c; color: white; padding: 15px 30px; border-radius: 8px; z-index: 10000; font-weight: bold; animation: blinker 0.8s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <h2 style="color:var(--gold)">EPIROC</h2>
            <p style="font-size: 0.8rem; color: #888;">CENTRAL VISUALIZER LOGIN</p>
            <input type="text" id="userInput" placeholder="Username">
            <input type="password" id="passInput" placeholder="Password">
            <button onclick="handleLogin()" style="background:var(--gold); color:#000; font-weight:bold; cursor:pointer;">SIGN IN</button>
        </div>
    </div>

    <div id="loader" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:15000; align-items:center; justify-content:center; color:var(--gold);">CONNECTING TO FLEET...</div>
    <div id="auditWarning" class="warning-popup">⚠️ Rig Has not covered mandatory minimum Audits</div>

    <aside id="sidebar">
        <h3 style="color:white; margin:0;">EPIROC</h3>
        <span id="userBadge" style="background:var(--gold); color:black; font-size:0.7rem; padding:2px 6px; font-weight:bold;">OFFLINE</span>
        
        <label style="margin-top:20px; display:block;">Model Classification</label>
        <select id="modelSelect" onchange="loadRigList()"></select>

        <label>Target Rig ID</label>
        <select id="rigSelect" onchange="loadRigDetails()"></select>

        <label>Target Month</label>
        <input type="month" id="targetMonth" onchange="loadRigDetails()">

        <h4 style="color:var(--gold); border-bottom:1px solid #333; margin: 20px 0 10px 0;">VITAL DATA</h4>
        <table class="vital-table">
            <tr><td>Boost Pressure</td><td id="vBoost" class="vital-val">--</td></tr>
            <tr><td>Fuel Pressure</td><td id="vFuel" class="vital-val">--</td></tr>
            <tr><td>Receiver Pr</td><td id="vReceiver" class="vital-val">--</td></tr>
            <tr><td>Hyd-Oil Temp</td><td id="vHydTemp" class="vital-val">--</td></tr>
        </table>
    </aside>

    <main id="main">
        <div id="thresholdBox">
            <h5 style="color:var(--gold); margin:0 0 10px 0;">THRESHOLD MONITOR</h5>
            <div id="threshContent"></div>
        </div>
        <div style="flex:1; background:var(--panel); border-radius:8px; padding:15px; min-height:400px;">
            <canvas id="mainChart"></canvas>
        </div>
    </main>

    <script>
        const API = "https://script.google.com/macros/s/AKfycby-LNy68o6cnEG2WngNpmWZYstBB-pGXIFoYApe4paxxfr_AG9zBuDyUu2iwWkSYH2b/exec";
        let session = {}, myChart = null;

        async function handleLogin() {
            const u = document.getElementById('userInput').value;
            const p = document.getElementById('passInput').value;
            document.getElementById('loader').style.display = 'flex';
            
            try {
                const res = await fetch(`${API}?get=login&user=${u}&pass=${p}`);
                const data = await res.json();
                if(data.success) {
                    session = data;
                    session.username = u;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('userBadge').innerText = data.logger;
                    initDashboard();
                } else { alert("Invalid login!"); }
            } catch(e) { alert("API Connection Failed"); }
            document.getElementById('loader').style.display = 'none';
        }

        function initDashboard() {
            const now = new Date();
            document.getElementById('targetMonth').value = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
            loadModels();
        }

        async function loadModels() {
            const res = await fetch(`${API}?get=model_list&userRegion=${session.region}&siteView=${session.siteView}&user=${session.username}`);
            const models = await res.json();
            let h = '<option value="All Models">All Models</option>';
            models.forEach(m => h += `<option value="${m}">${m}</option>`);
            document.getElementById('modelSelect').innerHTML = h;
            loadRigList();
        }

        async function loadRigList() {
            const m = document.getElementById('modelSelect').value;
            const res = await fetch(`${API}?get=list&model=${m}&userRegion=${session.region}&siteView=${session.siteView}&user=${session.username}`);
            const rigs = await res.json();
            let h = '<option value="">Select Rig</option>';
            rigs.forEach(r => h += `<option value="${r}">${r}</option>`);
            document.getElementById('rigSelect').innerHTML = h;
        }

        async function loadRigDetails() {
            const rig = document.getElementById('rigSelect').value;
            if(!rig) return;
            document.getElementById('loader').style.display = 'flex';
            const m = document.getElementById('targetMonth').value;
            
            const res = await fetch(`${API}?get=details&fleetId=${rig}&month=${m}&userRegion=${session.region}&siteView=${session.siteView}&user=${session.username}`);
            const data = await res.json();

            // Vitals
            document.getElementById('vBoost').innerText = data.vitals.boostPr;
            document.getElementById('vFuel').innerText = data.vitals.fuelPr;
            document.getElementById('vReceiver').innerText = data.vitals.receiverPr;
            document.getElementById('vHydTemp').innerText = data.vitals.hydOilTemp + "°C";

            // Threshold Box
            document.getElementById('thresholdBox').style.display = 'block';
            document.getElementById('threshContent').innerHTML = `
                <div class="thresh-line"><span>Model:</span><b>${data.thresholds.model}</b></div>
                <div class="thresh-line"><span>Max Temp:</span><b>${data.thresholds.maxTemp}°C</b></div>
                <div class="thresh-line"><span>Min Oil:</span><b>${data.thresholds.minOil} bar</b></div>
                <div class="thresh-line"><span>Max Fuel:</span><b>${data.thresholds.maxFuel} l/h</b></div>
            `;

            // Audit Warning
            const w = document.getElementById('auditWarning');
            if(data.monthlyAuditCount < 15) {
                w.style.display = 'block';
                setTimeout(()=> w.style.display = 'none', 30000);
            } else { w.style.display = 'none'; }

            drawChart(data.monthlyData);
            document.getElementById('loader').style.display = 'none';
        }

        function drawChart(rows) {
            if(myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: {
                    labels: rows.map(r => r.date),
                    datasets: [
                        { label: 'Impact', data: rows.map(r => r.highImpact), borderColor: '#f1c40f', tension: 0.3 },
                        { label: 'Feed', data: rows.map(r => r.feedPrHigh), borderColor: '#e67e22', tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
