<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EPIROC CENTRAL PARAMETER DASH VIEW</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ey: #f1c40f; --bg: #0d0d0d; --card: #1a1a1a; --red: #ff4d4d; --green: #2ecc71; --blue: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; overflow: hidden; }
        
        /* AUTH OVERLAY */
        #login-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: var(--card); padding: 40px; border-radius: 12px; border-top: 5px solid var(--ey); width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: var(--ey); color: #000; border: none; font-weight: bold; border-radius: 4px; cursor: pointer; margin-top: 10px; }

        /* DASHBOARD LAYOUT */
        #dashboard-content { opacity: 0; transition: 0.8s; pointer-events: none; }
        .authorized #dashboard-content { opacity: 1; pointer-events: auto; }
        .authorized #login-overlay { display: none; }

        .header { display: grid; grid-template-columns: 280px 1fr 280px; align-items: center; border-bottom: 3px solid var(--ey); padding-bottom: 15px; margin-bottom: 20px; }
        .header-left { display: flex; flex-direction: column; align-items: flex-start; }
        .header-center { text-align: center; }
        .header-center h1 { margin: 0; font-size: 1.8rem; letter-spacing: 2px; }

        .user-badge { background: var(--ey); color: #000; padding: 4px 12px; border-radius: 15px; font-weight: bold; font-size: 0.8rem; margin-top: 5px; display: inline-block; }
        .live-dot { height: 10px; width: 10px; background: var(--green); border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; margin-right: 5px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }

        /* GRID SYSTEM */
        .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; }
        .sidebar, .chart-area, .warning-sidebar { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); height: 85vh; overflow-y: auto; }
        
        .vital-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #111; border: 1px solid #333; }
        .vital-table td { padding: 10px; border-bottom: 1px solid #333; font-size: 0.8rem; }
        .v-label { color: #888; text-transform: uppercase; font-size: 0.65rem; }
        .v-value { text-align: right; color: var(--ey); font-weight: bold; font-size: 0.95rem; }

        .summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #111; font-size: 0.75rem; }
        .summary-table th, .summary-table td { padding: 8px; border: 1px solid #333; text-align: center; }
        .summary-table th { background: #222; color: var(--ey); text-transform: uppercase; }

        select, input { width: 100%; padding: 10px; margin-top: 8px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; }
        .mini-stats { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mini-card { background: #222; padding: 10px; border-radius: 4px; text-align: center; border: 1px solid #333; }
        .mini-card small { color: #888; display: block; font-size: 0.65rem; }
        .mini-card span { font-size: 1rem; font-weight: bold; color: var(--ey); }
        
        .btn-red { background: var(--red); color: white; border:none; padding:12px; border-radius:4px; font-weight:bold; width:100%; margin-top:15px; cursor:pointer;}
        .btn-green { background: #27ae60; color: white; border:none; padding:12px; border-radius:4px; font-weight:bold; width:100%; margin-top:10px; cursor:pointer;}

        #auditWarning { display: none; position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: var(--red); color: white; padding: 15px 30px; border-radius: 8px; font-weight: bold; z-index: 10000; animation: blinker 1s linear infinite; }
        @keyframes blinker { 0% { opacity: 1; } 50% { opacity: 0.7; box-shadow: 0 0 20px rgba(255, 77, 77, 0.6); } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="50">
        <h3>SYSTEM ACCESS</h3>
        <input type="text" id="userIn" placeholder="User ID">
        <input type="password" id="passIn" placeholder="Password">
        <button onclick="handleLogin()">AUTHORIZE ACCESS</button>
        <p id="login-msg" style="color:var(--red); font-size:0.8rem; margin-top:15px;"></p>
    </div>
</div>

<div id="dashboard-content">
    <div id="auditWarning" onclick="this.style.display='none'" style="cursor:pointer;">‚ö†Ô∏è RIG HAS NOT COVERED MANDATORY MINIMUM AUDITS</div>
    
    <div class="header">
        <div class="header-left">
            <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="45">
            <div><span class="live-dot"></span><span id="id-badge" class="user-badge">IDENTIFYING...</span></div>
        </div>
        <div class="header-center">
            <h1>EPIROC CENTRAL PARAMETER DASH VIEW</h1>
            <div style="font-size: 0.8rem; color: #888; margin-top:5px;">LIVE STATUS | <span id="last-sync">--:--:--</span></div>
        </div>
        <div class="header-right"></div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div class="filter-group" id="mgmt-city-box" style="display:none; margin-bottom: 15px; border-top: 1px solid #444; padding-top: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label style="color: var(--ey); font-size: 0.85rem;"><i class="fas fa-globe-asia"></i> REGION SECTOR</label>
                    <button onclick="resetCityFilter()" style="background: none; border: 1px solid var(--ey); color: var(--ey); font-size: 0.65rem; padding: 2px 6px; cursor: pointer; border-radius: 3px;">RESET</button>
                </div>
                <select id="cityFocus" onchange="handleRegionChange()" style="width: 100%; background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 4px;">
                    <option value="All">All India (National)</option>
                    <option value="Ranchi">Ranchi</option>
                    <option value="Hyderabad">Hyderabad</option>
                    <option value="Delhi">Delhi</option>
                    <option value="Nagpur">Nagpur</option>
                    <option value="Udaipur">Udaipur</option>
                    <option value="Kolkata">Kolkata</option>
                </select>
            </div>

            <label>Model Classification</label>
            <select id="modelSelect" onchange="applyGlobalFilters()" style="width: 100%; background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 4px; margin-bottom: 15px;">
                <option value="">All Models</option>
            </select>

            <label for="dataSource">Data View:</label>
            <select id="dataSource" onchange="refresh()">
                <option value="active" selected>Live (Present)</option>
                <option value="history">Archive (Pre-Nov 2025)</option>
            </select>

            <label style="display:block; margin-top:15px;">Target Rig ID</label>
            <select id="rigSelect" onchange="refresh()"><option>Loading...</option></select>
            
            <label style="display:block; margin-top:15px;">Target Month</label>
            <input type="month" id="monthFilter" onchange="refresh()">

            <h4 style="color:var(--ey); margin: 25px 0 5px 0; font-size: 0.85rem; border-bottom: 1px solid #333; padding-bottom: 5px;">
                MACHINE VITALS <span id="v-date" style="float:right; color:#888; font-size:0.7rem;">--</span>
            </h4>
            <table class="vital-table">
                <tr><td class="v-label">Boost Pressure</td><td id="v-boost" class="v-value">--</td></tr>
                <tr><td class="v-label">Fuel Pressure</td><td id="v-fuel" class="v-value">--</td></tr>
                <tr><td class="v-label">Receiver Pr</td><td id="v-receiver" class="v-value">--</td></tr>
                <tr><td class="v-label">Hyd-Oil Temp</td><td id="v-hyd-temp" class="v-value">--</td></tr>
            </table>

            <label style="display:block; margin-top:15px;">Analysis Mode</label>
            <select id="chartMode" onchange="drawChart()">
                <option value="tempVsOil">Trend: Temp / Oil / RPM</option>
                <option value="loadVsComp">Load vs Compressor %</option>
                <option value="setBit">DTH: Set vs Bit Pressure</option>
                <option value="hydro_impact">Hydraulic: Impact/Feed/Damper</option>
            </select>

            <div class="mini-stats">
                <div class="mini-card"><small>Fleet Avg Load</small><span id="v-fleet-load">--</span></div>
                <div class="mini-card"><small>Active Assets</small><span id="v-active-rigs">--</span></div>
            </div>

            <button onclick="window.print()" class="btn-red">üìÑ GENERATE PDF</button>
            <button onclick="exportToExcel()" class="btn-green">üìä EXCEL EXPORT</button>
        </div>

        <div class="chart-area">
            <div style="height:350px;"><canvas id="mainChart"></canvas></div>
            <h3 style="color:var(--ey); margin:30px 0 10px 0;">FLEET PERFORMANCE SUMMARY</h3>
            <table class="summary-table" id="summary-tbl">
                <thead>
                    <tr><th rowspan="2">Rig ID</th><th rowspan="2">Audits</th><th colspan="4">Engine Health</th><th colspan="3">Productivity</th></tr>
                    <tr><th>Load %</th><th>Temp ¬∞C</th><th>Oil bar</th><th>Fuel bar</th><th>Air Set</th><th>Bit Pr</th><th>Impact</th></tr>
                </thead>
                <tbody id="fleet-summary-body"></tbody>
            </table>
        </div>

        <div class="warning-sidebar">
            <h3 style="color:var(--red); margin:0 0 15px 0; border-bottom: 1px solid #333; padding-bottom: 10px;">‚ö†Ô∏è TRIGGER ALERTS</h3>
            <div id="alert-list">Scanning...</div>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbw7md2m_7zkOYB0Q20VmEEc_f-bJno2VdnEOpQ83752-TUOppl48CdeUgZFZyucHYzi/exec"; 
    let chart = null, globalData = null;

    async function handleLogin() {
        const u = document.getElementById('userIn').value;
        const p = document.getElementById('passIn').value;
        const msg = document.getElementById('login-msg');
        if (!u || !p) { msg.innerText = "Please enter credentials."; return; }
        msg.innerText = "Authenticating...";
        try {
            const resp = await fetch(`${API}?get=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
            const data = await resp.json();
            if (data.success) {
                sessionStorage.setItem('region', data.region);
                sessionStorage.setItem('siteView', data.siteView);
                sessionStorage.setItem('user', u);
                sessionStorage.setItem('logger', data.logger);
                document.getElementById('id-badge').innerText = `${u}-${data.logger}`;
                if (data.role === 'mgmt' || data.region === 'All') {
                    document.getElementById('mgmt-city-box').style.display = 'block';
                }
                document.body.classList.add('authorized');
                init(); 
            } else { msg.innerText = "Invalid Login."; }
        } catch (e) { msg.innerText = "Connection Failed."; }
    }

    function getFullUrl(params) {
        const r = sessionStorage.getItem('region'), s = sessionStorage.getItem('siteView'), u = sessionStorage.getItem('user');
        return `${API}?${params}&userRegion=${encodeURIComponent(r)}&siteView=${encodeURIComponent(s)}&user=${encodeURIComponent(u)}&v=${Date.now()}`;
    }

    async function init() {
        const now = new Date(); 
        document.getElementById('monthFilter').value = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
        try {
            const mRes = await fetch(getFullUrl("get=model_list"));
            const mList = await mRes.json();
            document.getElementById('modelSelect').innerHTML = '<option value="">All Models</option>' + mList.map(m => `<option value="${m}">${m}</option>`).join('');
            await updateRigDropdown(); 
            if (window.refreshInterval) clearInterval(window.refreshInterval);
            window.refreshInterval = setInterval(() => { refresh(); }, 60000); 
        } catch (e) { console.error(e); }
    }

    async function updateRigDropdown() {
        const model = document.getElementById('modelSelect').value;
        const res = await fetch(getFullUrl(`get=list&model=${encodeURIComponent(model)}`));
        const rigs = await res.json();
        document.getElementById('rigSelect').innerHTML = rigs.map(id => `<option value="${id}">${id}</option>`).join('');
        refresh();
    }

    async function refresh() {
        const rig = document.getElementById('rigSelect').value;
        const month = document.getElementById('monthFilter').value; 
        const mode = document.getElementById('dataSource').value; 
        const cleanRig = (rig === "Loading..." || !rig) ? "" : rig;
        try {
            const res = await fetch(getFullUrl(`fleetId=${encodeURIComponent(cleanRig)}&month=${month}&mode=${mode}`));
            const data = await res.json();
            globalData = data;
            updateUI(data);
        } catch (err) { console.error(err); }
    }

   function updateUI(data) {
    if (data.summary && data.summary.length > 0) {
        document.getElementById('fleet-summary-body').innerHTML = data.summary.map(r => `
            <tr data-region="${r.region || ''}" data-model="${r.model || ''}">
                <td><b>${r.id}</b></td>
                <td>${r.audits}</td>
                <td>${r.avgLoad}%</td>
                <td>${r.avgTemp}</td>
                <td>${r.avgOil}</td>
                <td>${r.avgFuel}</td>
                <td>${r.avgAir}</td>
                <td>${r.avgBit}</td>
                <td>${r.avgImpact}</td>
            </tr>`).join('');
    }

    // Process Machine Vitals
    if (data.vitals) {
        document.getElementById('v-boost').innerText = data.vitals.boost || "0";
        document.getElementById('v-fuel').innerText = data.vitals.fuel || "0";
        document.getElementById('v-receiver').innerText = data.vitals.rec || "0";
        document.getElementById('v-hyd-temp').innerText = (data.vitals.hyd || "0") + "¬∞C";
    }

    // --- CRITICAL SYNC ---
    // We force the filters to run AFTER the table is built
    applyGlobalFilters(); 
    drawChart();
    document.getElementById('last-sync').innerText = new Date().toLocaleTimeString();
}
        // Audit Warning Timer (15 Seconds)
        const warning = document.getElementById('auditWarning');
        const selectedRigId = document.getElementById('rigSelect').value;
        const rigStats = data.summary ? data.summary.find(r => r.id === selectedRigId) : null;
        const currentAudits = rigStats ? parseInt(rigStats.audits) : 0;

        if (selectedRigId && currentAudits > 0 && currentAudits < 15) {
            warning.style.display = 'block';
            warning.innerText = `‚ö†Ô∏è RIG HAS ONLY COVERED ${currentAudits} AUDITS THIS MONTH (Min: 15)`;
            if (window.auditTimer) clearTimeout(window.auditTimer);
            window.auditTimer = setTimeout(() => { warning.style.display = 'none'; }, 15000); 
        } else {
            warning.style.display = 'none';
        }
    }

    // 4. Final Sync
    applyGlobalFilters(); 
    drawChart();
    document.getElementById('last-sync').innerText = new Date().toLocaleTimeString();
}

    function drawChart() {
        if (!globalData || !globalData.monthlyData || globalData.monthlyData.length === 0) {
            if (chart) chart.destroy(); return;
        }
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chart) chart.destroy();
        const mode = document.getElementById('chartMode').value;
        const d = globalData.monthlyData;
        const labels = d.map(x => x.date);
        let datasets = [], options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#fff' } } }, scales: { x: { grid: { color: '#333' }, ticks: { color: '#888' } }, y: { grid: { color: '#333' }, ticks: { color: '#888' } } } };

        if (mode === 'tempVsOil') {
            datasets = [
                { label: 'Oil (bar)', data: d.map(x => x.oil), borderColor: '#2ecc71', yAxisID: 'yOil', tension: 0.3 },
                { label: 'Temp (¬∞C)', data: d.map(x => x.temp), borderColor: '#e74c3c', yAxisID: 'yTemp', tension: 0.3 },
                { label: 'RPM', data: d.map(x => x.rpm), borderColor: '#3498db', yAxisID: 'yRPM', borderDash: [5, 5], tension: 0.3 }
            ];
            options.scales.yOil = { position: 'left', min: 0, max: 8 };
            options.scales.yTemp = { position: 'right', min: 60, max: 130 };
            options.scales.yRPM = { position: 'right', min: 600, max: 2200, grid: { drawOnChartArea: false } };
        } else if (mode === 'hydro_impact') {
            datasets = [
                { label: 'Impact', data: d.map(x => x.impact), borderColor: '#f1c40f' },
                { label: 'Feed', data: d.map(x => x.feed), borderColor: '#e67e22' },
                { label: 'Damper', data: d.map(x => x.damper), borderColor: '#3498db' }
            ];
        } else if (mode === 'loadVsComp') {
            datasets = [
                { label: 'Load %', data: d.map(x => x.load), borderColor: '#f1c40f' },
                { label: 'Compressor %', data: d.map(x => x.comp), borderColor: '#3498db' }
            ];
        } else if (mode === 'setBit') {
            datasets = [
                { label: 'Bit Pr', data: d.map(x => x.bit), borderColor: '#3498db' },
                { label: 'Air Set', data: d.map(x => x.air), borderColor: '#2ecc71' }
            ];
        }
        chart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: options });
    }
function handleRegionChange() {
    const selectedRegion = document.getElementById('cityFocus').value;
    const rows = document.querySelectorAll('#fleet-summary-body tr');
    const modelDropdown = document.getElementById('modelSelect');
    
    // Step A: Find unique models present in this region
    let availableModels = new Set();
    rows.forEach(row => {
        const rowRegion = row.getAttribute('data-region');
        const rowModel = row.getAttribute('data-model');
        if (selectedRegion === "All" || rowRegion === selectedRegion) {
            if (rowModel) availableModels.add(rowModel);
        }
    });

    // Step B: Update the Model dropdown list dynamically
    let modelHTML = '<option value="">All Models</option>';
    availableModels.forEach(m => {
        modelHTML += `<option value="${m}">${m}</option>`;
    });
    modelDropdown.innerHTML = modelHTML;

    function applyGlobalFilters() {
    try {
        const selRegion = document.getElementById('cityFocus').value;
        const selModel = document.getElementById('modelSelect').value;
        const rows = document.querySelectorAll('#fleet-summary-body tr');
        const rigDropdown = document.getElementById('rigSelect');
        
        if (!rigDropdown) return; // Safety check to prevent freezing if element is missing

        let count = 0;
        let totalLoad = 0;
        let rigs = [];

        rows.forEach(row => {
            // Use .getAttribute safely to prevent "null" errors
            const rowReg = (row.getAttribute('data-region') || "").trim();
            const rowMod = (row.getAttribute('data-model') || "").trim();
            const rigID = row.cells[0].innerText.trim();

            const matchReg = (selRegion === "All" || rowReg === selRegion);
            const matchMod = (selModel === "" || rowMod === selModel);

            if (matchReg && matchMod) {
                row.style.display = "";
                count++;
                rigs.push(rigID);
                const loadText = row.cells[2] ? row.cells[2].innerText : "0";
                const loadVal = parseFloat(loadText.replace('%','')) || 0;
                totalLoad += loadVal;
            } else {
                row.style.display = "none";
            }
        });

        // REBUILD RIG DROPDOWN
        if (rigs.length > 0) {
            rigs.sort();
            rigDropdown.innerHTML = rigs.map(id => `<option value="${id}">${id}</option>`).join('');
        } else {
            rigDropdown.innerHTML = '<option value="">No Rigs Found</option>';
        }

        // UPDATE SIDEBAR STATS
        const activeDisplay = document.getElementById('v-active-rigs');
        const loadDisplay = document.getElementById('v-fleet-load');
        
        if (activeDisplay) activeDisplay.innerText = count;
        if (loadDisplay) loadDisplay.innerText = count > 0 ? (totalLoad / count).toFixed(1) + "%" : "0%";
        
    } catch (error) {
        console.error("Filter Error: ", error);
    }
}

function resetCityFilter() {
    const cityFocus = document.getElementById('cityFocus');
    const modelSelect = document.getElementById('modelSelect');
    if (cityFocus) cityFocus.value = "All";
    if (modelSelect) modelSelect.value = "";
    applyGlobalFilters();
}

function exportToExcel() {
    const table = document.getElementById("summary-tbl");
    if (!table) return;
    const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
    const link = document.createElement('a');
    link.download = "Fleet_Report.xls";
    link.href = url;
    link.click();
}
</script>
</body>
</html>





