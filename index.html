<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Epiroc Parameter OverView</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ey: #f1c40f; --bg: #0d0d0d; --card: #1a1a1a; --red: #ff4d4d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; opacity:0; transition: 0.5s; }
        .authorized { opacity: 1; }
        .header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--ey); padding-bottom: 10px; margin-bottom: 20px; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card); padding: 15px; border-radius: 8px; border-top: 4px solid var(--ey); text-align: center; }
        .stat-box div { font-size: 1.8rem; font-weight: bold; color: var(--ey); }

        .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; }
        .sidebar, .chart-area, .warning-sidebar { background: var(--card); padding: 20px; border-radius: 8px; }
        
        .warning-sidebar { border: 1px solid var(--red); height: 550px; overflow-y: auto; }
        .alert-card { background: #2d0000; border-left: 4px solid var(--red); padding: 12px; margin-bottom: 10px; font-size: 0.8rem; }
        .alert-card b { color: var(--red); font-size: 0.9rem; }

        select, input { width: 100%; padding: 12px; margin-top: 8px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; }
        .chart-container { height: 450px; width: 100%; }
        .live-dot { height: 10px; width: 10px; background: #2ecc71; border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1 style="margin:0;">EPIROC EXECUTIVE OVERSIGHT</h1>
        <div style="color:#2ecc71; font-size:0.9rem;"><div class="live-dot"></div> LIVE FLEET STATUS | <span id="last-sync">--:--:--</span></div>
    </div>
    <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="50">
</div>

<div class="stat-grid">
    <div class="stat-box"><small>MONTHLY AUDITS</small><div id="s-count">0</div></div>
    <div class="stat-box"><small>AVG ENGINE LOAD</small><div id="s-load">0%</div></div>
    <div class="stat-box"><small>CURRENT ENGINE RPM</small><div id="s-rpm">0</div></div>
</div>

<div class="main-layout">
    <div class="sidebar">
        <label>Machine Selection</label>
        <select id="rigSelect" onchange="refresh()"><option>Loading...</option></select>
        <label style="display:block; margin-top:15px;">Historical Month</label>
        <input type="month" id="monthFilter" onchange="refresh()">
        <label style="display:block; margin-top:15px;">Analysis Mode</label>
        <select id="chartMode" onchange="drawChart()">
            <option value="loadVsComp">Load vs Compressor %</option>
            <option value="tempVsOil">Temp vs Oil Pressure</option>
            <option value="compVsRpm">Comp Temp vs RPM</option>
        </select>
        <div style="margin-top:30px; font-size:0.85rem; color:#888;">
            <p>Latest Data Point:</p>
            <div style="display:flex; justify-content:space-between;"><span>Oil:</span><b id="v-oil">--</b></div>
            <div style="display:flex; justify-content:space-between;"><span>Temp:</span><b id="v-temp">--</b></div>
        </div>
    </div>

    <div class="chart-area">
        <div class="chart-container"><canvas id="mainChart"></canvas></div>
    </div>

    <div class="warning-sidebar">
        <h3 style="color:var(--red); margin:0 0 15px 0;">⚠️ FLEET ALERTS</h3>
        <div id="alert-list">Scanning fleet...</div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbxuPOfTJZ10szVN9l1rDKqlMtytWh3pNirrze4GCSxAWpDRC8igAph59uLUXbZZQnzf/exec";
    let chart = null;
    let globalData = null;

    window.onload = async () => {
        const u = prompt("Management ID"), p = prompt("Password");
        const res = await fetch(`${API}?get=login&user=${u}&pass=${p}`);
        const data = await res.json();
        if(data.success) { document.body.classList.add('authorized'); init(); } 
        else { location.reload(); }
    };

    async function init() {
        const res = await fetch(`${API}?get=list`);
        const list = await res.json();
        document.getElementById('rigSelect').innerHTML = list.map(id => `<option value="${id}">${id}</option>`).join('');
        setInterval(refresh, 45000); // 45s Auto-Refresh
        refresh();
    }

    async function refresh() {
        const rig = document.getElementById('rigSelect').value;
        const month = document.getElementById('monthFilter').value;
        if(!rig) return;

        // Parallel Fetch for Data and Fleet-wide Warnings
        const [dRes, wRes] = await Promise.all([
            fetch(`${API}?fleetId=${encodeURIComponent(rig)}&month=${month}&v=${Date.now()}`),
            fetch(`${API}?get=warnings&v=${Date.now()}`)
        ]);

        globalData = await dRes.json();
        const alerts = await wRes.json();

        // Update Stats
        document.getElementById('s-count').innerText = globalData.stats.auditCount;
        document.getElementById('s-load').innerText = globalData.stats.avgLoad + "%";
        document.getElementById('s-rpm').innerText = globalData.latest.engRpm;
        document.getElementById('v-oil').innerText = globalData.latest.engOil + " bar";
        document.getElementById('v-temp').innerText = globalData.latest.engTemp + "°C";
        document.getElementById('last-sync').innerText = new Date().toLocaleTimeString();

        // Update Warnings
        document.getElementById('alert-list').innerHTML = alerts.length ? alerts.map(a => `
            <div class="alert-card">
                <b>${a.id}</b><br>
                ${a.oil < a.oilLimit ? `❌ Low Oil: ${a.oil}<br>` : ''}
                ${a.temp > a.tempLimit ? `❌ High Temp: ${a.temp}` : ''}
                <div style="color:#888; font-size:0.7rem; margin-top:5px;">Last: ${a.time}</div>
            </div>
        `).join('') : "<p style='color:#2ecc71'>✅ Fleet Healthy</p>";

        drawChart();
    }

    function drawChart() {
        const mode = document.getElementById('chartMode').value;
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        const d = globalData.monthlyData;
        let datasets = [];

        if(mode === 'loadVsComp') {
            datasets = [
                { label: 'Load %', data: d.map(x => x.engLoad), borderColor: '#f1c40f', yAxisID: 'y' },
                { label: 'Comp %', data: d.map(x => x.compPerc), borderColor: '#3498db', yAxisID: 'y' }
            ];
        } else if(mode === 'tempVsOil') {
            datasets = [
                { label: 'Temp °C', data: d.map(x => x.engTemp), borderColor: '#e74c3c', yAxisID: 'y' },
                { label: 'Oil bar', data: d.map(x => x.engOil), borderColor: '#2ecc71', yAxisID: 'y1' }
            ];
        } else {
            datasets = [
                { label: 'Comp Temp °C', data: d.map(x => x.compLow), borderColor: '#e67e22', yAxisID: 'y' },
                { label: 'RPM', data: d.map(x => x.engRpm), borderColor: '#9b59b6', yAxisID: 'y1' }
            ];
        }

        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: d.map(x => x.date), datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { position: 'left', grid: { color: '#333' } },
                    y1: { display: mode !== 'loadVsComp', position: 'right', grid: { drawOnChartArea: false } }
                }
            }
        });
    }
</script>
</body>
</html>


