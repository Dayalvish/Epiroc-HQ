<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EPIROC CENTRAL PARAMETER VISUALIZER</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ey: #f1c40f; --bg: #0d0d0d; --card: #1a1a1a; --red: #ff4d4d; --green: #2ecc71; --blue: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; opacity:0; transition: 0.5s; }
        .authorized { opacity: 1 !important; }
        .header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--ey); padding-bottom: 10px; margin-bottom: 20px; }
        .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; }
        .sidebar, .chart-area, .warning-sidebar { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        /* Table Styling with Merged Headers */
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #111; font-size: 0.8rem; }
        .summary-table th, .summary-table td { padding: 10px; border: 1px solid #333; text-align: center; }
        .summary-table th { background: #222; color: var(--ey); text-transform: uppercase; font-size: 0.65rem; letter-spacing: 1px; }
        
        /* Sidebar Components */
        select, input { width: 100%; padding: 12px; margin-top: 8px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; outline: none; }
        select:focus { border-color: var(--ey); }
        .mini-stats { margin-top: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mini-card { background: #222; padding: 12px; border-radius: 4px; text-align: center; border: 1px solid #333; transition: 0.3s; }
        .mini-card:hover { border-color: var(--ey); }
        .mini-card small { font-size: 0.6rem; color: #888; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .mini-card span { font-size: 1.1rem; font-weight: bold; color: var(--ey); }

        /* Warnings & Alerts */
        .warning-sidebar { border: 1px solid var(--red); height: 750px; overflow-y: auto; }
        .alert-card { background: #222; padding: 12px; margin-bottom: 12px; border-left: 5px solid var(--red); border-radius: 4px; font-size: 0.8rem; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .live-dot { height: 10px; width: 10px; background: var(--green); border-radius: 50%; display: inline-block; margin-right: 5px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }
        
        /* Search Bar */
        .search-box { margin-bottom: 10px; position: relative; }
        .search-box input { padding-left: 35px; border-radius: 20px; }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1 style="margin:0; letter-spacing: 1px;">EPIROC CENTRAL PARAMETER VISUALIZER</h1>
        <div style="color:var(--green); font-size:0.9rem; margin-top:5px;">
            <div class="live-dot"></div> LIVE FLEET STATUS | <span id="last-sync">--:--:--</span>
        </div>
    </div>
    <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="55" alt="Epiroc Logo">
</div>

<div class="main-layout">
    <div class="sidebar">
        <label>Model Classification</label>
        <select id="modelSelect" onchange="updateRigDropdown()"><option value="">All Models</option></select>
        
        <label style="display:block; margin-top:15px;">Target Rig ID</label>
        <select id="rigSelect" onchange="refresh()"><option>Loading...</option></select>
        
        <label style="display:block; margin-top:15px;">Data Analysis Mode</label>
        <select id="chartMode" onchange="drawChart()">
            <option value="loadVsComp">Load vs Compressor %</option>
            <option value="tempVsOil">Engine Temp vs Oil Pressure</option>
            <option value="setBit">Set Air vs Bit Pressure</option>
            <option value="hydro_impact">Impact vs Feed & Damper</option>
            <option value="compVsRpm">Comp Temp vs Engine RPM</option>
        </select>

        <div class="mini-stats">
            <div class="mini-card"><small>Fleet Avg Load</small><span id="v-fleet-load">--</span></div>
            <div class="mini-card"><small>Active Assets</small><span id="v-active-rigs">--</span></div>
            <div class="mini-card"><small>Avg Air Set</small><span id="v-avg-airset">--</span></div>
            <div class="mini-card"><small>Air Efficiency</small><span id="v-air-eff">--</span></div>
        </div>

        <button onclick="window.print()" style="width:100%; padding:12px; background:var(--red); color:white; border:none; border-radius:4px; cursor:pointer; margin-top:25px; font-weight:bold;">üìÑ GENERATE PDF REPORT</button>
        <button onclick="exportToExcel()" style="width:100%; padding:12px; background:#27ae60; color:white; border:none; border-radius:4px; cursor:pointer; margin-top:10px; font-weight:bold;">üìä EXCEL EXPORT</button>
    </div>

    <div class="chart-area">
        <div style="height:350px;"><canvas id="mainChart"></canvas></div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
            <h3 style="color:var(--ey); margin:0;">FLEET PERFORMANCE SUMMARY</h3>
            <div class="search-box" style="width: 250px;">
                <input type="text" id="tableSearch" onkeyup="filterTable()" placeholder="Search Rig ID...">
            </div>
        </div>

        <table class="summary-table" id="summary-tbl">
            <thead>
                <tr>
                    <th rowspan="2">Rig ID</th>
                    <th rowspan="2">Audits</th>
                    <th colspan="4">Engine Health</th>
                    <th colspan="3">Drilling Productivity</th>
                </tr>
                <tr>
                    <th>Load %</th><th>Temp ¬∞C</th><th>Oil bar</th><th>Fuel bar</th>
                    <th>Air Set</th><th>Bit Pr</th><th>Impact</th>
                </tr>
            </thead>
            <tbody id="fleet-summary-body"></tbody>
        </table>
    </div>

    <div class="warning-sidebar" id="alert-list">Scanning fleet thresholds...</div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbw0YfSKELPicNMmOEItwXJ_K9e4pWy0n1KCjdFswuLJ0V9MAN7g77gRWejm6gtBpzME/exec";
    let chart = null, globalData = null;

    window.onload = async () => {
        const u = prompt("Management ID"), p = prompt("Password");
        try {
            const res = await fetch(`${API}?get=login&user=${u}&pass=${p}`);
            const data = await res.json();
            if(data.success) { document.body.classList.add('authorized'); init(); } 
            else { alert("Access Denied"); location.reload(); }
        } catch(e) { alert("Security Handshake Failed"); }
    };

    async function init() {
        const mRes = await fetch(`${API}?get=model_list`);
        const mList = await mRes.json();
        document.getElementById('modelSelect').innerHTML = '<option value="">All Models</option>' + mList.map(m => `<option value="${m}">${m}</option>`).join('');
        await updateRigDropdown(); 
        setInterval(refresh, 60000); 
    }

    async function updateRigDropdown() {
        const model = document.getElementById('modelSelect').value;
        const res = await fetch(`${API}?get=list&model=${encodeURIComponent(model)}&v=${Date.now()}`);
        const rigs = await res.json();
        document.getElementById('rigSelect').innerHTML = rigs.map(id => `<option value="${id}">${id}</option>`).join('');
        refresh();
    }

    async function refresh() {
        const rig = document.getElementById('rigSelect').value, model = document.getElementById('modelSelect').value;
        if(!rig) return;

        const [dRes, sRes, wRes] = await Promise.all([
            fetch(`${API}?fleetId=${encodeURIComponent(rig)}&v=${Date.now()}`),
            fetch(`${API}?get=fleet_summary&model=${model}&v=${Date.now()}`),
            fetch(`${API}?get=warnings&v=${Date.now()}`)
        ]);

        globalData = await dRes.json();
        const summary = await sRes.json(), alerts = await wRes.json();

        // Update Dashboard Analytics
        if(summary.length > 0) {
            const avgLoad = (summary.reduce((s, r) => s + parseFloat(r.avgLoad), 0) / summary.length).toFixed(1);
            const avgAirSet = (summary.reduce((s, r) => s + parseFloat(r.avgAirSet || 0), 0) / summary.length).toFixed(1);
            const totalBit = summary.reduce((s, r) => s + parseFloat(r.avgBitPr || 0), 0);
            const totalSet = summary.reduce((s, r) => s + parseFloat(r.avgAirSet || 0), 1);
            
            document.getElementById('v-fleet-load').innerText = avgLoad + "%";
            document.getElementById('v-active-rigs').innerText = summary.length;
            document.getElementById('v-avg-airset').innerText = avgAirSet;
            document.getElementById('v-air-eff').innerText = ((totalBit/totalSet)*100).toFixed(1) + "%";
        }

        document.getElementById('last-sync').innerText = new Date().toLocaleTimeString();
        
        // Render Table Rows
        document.getElementById('fleet-summary-body').innerHTML = summary.map(row => `
            <tr>
                <td><b>${row.id}</b></td>
                <td>${row.monthlyAudits}</td>
                <td>${row.avgLoad}%</td>
                <td>${row.avgTemp}¬∞C</td>
                <td>${row.avgOil}b</td>
                <td>${row.avgFuel}b</td>
                <td>${row.avgAirSet}</td>
                <td>${row.avgBitPr}</td>
                <td>${row.avgImpact}</td>
            </tr>`).join('');
        
        // Render Active Warnings
        document.getElementById('alert-list').innerHTML = alerts.length ? alerts.map(a => `
            <div class="alert-card">
                <b>${a.id}</b> <span style="float:right; color:#888;">${a.time}</span><br>
                ${a.temp > a.tempLimit ? `<span style="color:var(--red)">‚ö†Ô∏è High Temp: ${a.temp}¬∞C</span><br>` : ''}
                ${a.oil < a.oilLimit ? `<span style="color:var(--red)">‚ö†Ô∏è Low Oil: ${a.oil}b</span>` : ''}
            </div>`).join('') : "<p style='color:var(--green); text-align:center;'>‚úÖ Fleet Healthy</p>";

        drawChart();
    }

    function filterTable() {
        let input = document.getElementById("tableSearch"), filter = input.value.toUpperCase();
        let tr = document.getElementById("fleet-summary-body").getElementsByTagName("tr");
        for (let i = 0; i < tr.length; i++) {
            let td = tr[i].getElementsByTagName("td")[0];
            if (td) tr[i].style.display = td.innerText.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }

    function exportToExcel() {
        let table = document.getElementById("summary-tbl"), url = 'data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
        let link = document.createElement('a'); link.download = "Epiroc_Fleet_Summary.xls"; link.href = url; link.click();
    }

    function drawChart() {
        const mode = document.getElementById('chartMode').value, ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        const d = globalData.monthlyData;
        
        let datasets = [], labels = d.map(x => x.date);
        let scales = {
            y: { type: 'linear', display: true, position: 'left', grid: { color: '#333' }, title: { display: true, text: 'Value', color: '#888'} },
            y1: { type: 'linear', display: false, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Secondary', color: '#888'} }
        };

        if(mode === 'hydro_impact') {
            scales.y1.display = true;
            datasets = [
                { label: 'Feed Pressure', data: d.map(x => x.feedPrHigh), borderColor: '#ff5722', yAxisID: 'y', tension: 0.3 },
                { label: 'Damper Pressure', data: d.map(x => x.damperPrHigh), borderColor: '#3498db', yAxisID: 'y', tension: 0.3 },
                { label: 'Impact Pressure', data: d.map(x => x.highImpact), borderColor: '#f1c40f', yAxisID: 'y1', borderDash: [5, 5], tension: 0.3 }
            ];
        } else if(mode === 'setBit') {
            datasets = [
                { label: 'Air Set', data: d.map(x => x.fullAirSet), borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.1)', fill: true },
                { label: 'Bit Pressure', data: d.map(x => x.pressureFull), borderColor: '#e74c3c' }
            ];
        } else if(mode === 'tempVsOil') {
            scales.y1.display = true;
            datasets = [
                { label: 'Temp ¬∞C', data: d.map(x => x.engTemp), borderColor: '#e74c3c', yAxisID: 'y' },
                { label: 'Oil bar', data: d.map(x => x.engOil), borderColor: '#2ecc71', yAxisID: 'y1' }
            ];
        } else if(mode === 'compVsRpm') {
            scales.y1.display = true;
            datasets = [
                { label: 'RPM', data: d.map(x => x.engRpm), borderColor: '#9b59b6', yAxisID: 'y' },
                { label: 'Comp Temp', data: d.map(x => x.compLow), borderColor: '#e67e22', yAxisID: 'y1' }
            ];
        } else {
            datasets = [
                { label: 'Eng Load %', data: d.map(x => x.engLoad), borderColor: '#f1c40f' },
                { label: 'Comp %', data: d.map(x => x.compPerc), borderColor: '#3498db' }
            ];
        }

        chart = new Chart(ctx, { 
            type: 'line', 
            data: { labels: labels, datasets: datasets }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                interaction: { mode: 'index', intersect: false },
                scales: scales,
                plugins: { legend: { position: 'top', labels: { color: '#fff', font: { size: 11 }, usePointStyle: true } } }
            } 
        });
    }
</script>
</body>
</html>
