<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EPIROC CENTRAL PARAMETER DASH</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1"></script>
    <style>
        :root { --ey: #f1c40f; --bg: #0d0d0d; --card: #1a1a1a; --red: #ff4d4d; --green: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; overflow: hidden; }
        #login-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: var(--card); padding: 40px; border-radius: 12px; border-top: 5px solid var(--ey); width: 350px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: var(--ey); color: #000; border: none; font-weight: bold; cursor: pointer; }
        #dashboard-content { opacity: 0; pointer-events: none; }
        .authorized #dashboard-content { opacity: 1; pointer-events: auto; }
        .authorized #login-overlay { display: none; }
        .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; height: 85vh; }
        .sidebar, .chart-area, .warning-sidebar { background: var(--card); padding: 20px; border-radius: 8px; overflow-y: auto; }
        .vital-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .v-label { color: #888; font-size: 0.7rem; }
        .v-value { text-align: right; color: var(--ey); font-weight: bold; }
        .summary-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; text-align: center; }
        .summary-table th { background: #222; color: var(--ey); padding: 8px; border: 1px solid #333; }
        .summary-table td { border: 1px solid #333; padding: 5px; }
        select, input { width: 100%; padding: 8px; margin-top: 5px; background: #222; color: #fff; border: 1px solid #444; }
        @keyframes blinker { 50% { opacity: 0.4; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h3>EPIROC SYSTEM ACCESS</h3>
        <input type="text" id="userIn" placeholder="User ID">
        <input type="password" id="passIn" placeholder="Password">
        <button onclick="handleLogin()">AUTHORIZE</button>
        <p id="login-msg" style="color:var(--red);"></p>
    </div>
</div>

<div id="dashboard-content">
    <div class="main-layout">
        <div class="sidebar">
            <label>Model Classification</label>
            <select id="modelSelect" onchange="updateRigDropdown()"><option value="">All Models</option></select>
            <label style="display:block; margin-top:10px;">Rig ID</label>
            <select id="rigSelect" onchange="refresh()"><option>Loading...</option></select>
            <label style="display:block; margin-top:10px;">Target Month</label>
            <input type="month" id="monthFilter" onchange="refresh()">

            <h4 style="color:var(--ey); border-bottom:1px solid #333; padding-bottom:5px; margin-top:20px;">
                MACHINE VITALS <span id="v-date" style="float:right; color:#888; font-size:0.7rem;">--</span>
            </h4>
            <table class="vital-table">
                <tr><td class="v-label">BOOST PR</td><td id="v-boost" class="v-value">--</td></tr>
                <tr><td class="v-label">FUEL PR</td><td id="v-fuel" class="v-value">--</td></tr>
                <tr><td class="v-label">HYD TEMP</td><td id="v-hyd-temp" class="v-value">--</td></tr>
            </table>

            <label style="display:block; margin-top:20px;">Chart Mode</label>
            <select id="chartMode" onchange="drawChart()">
                <option value="tempVsOil">Trend: Temp / Oil / RPM</option>
                <option value="loadVsComp">Load vs Compressor %</option>
            </select>
        </div>

        <div class="chart-area">
            <div style="height:350px;"><canvas id="mainChart"></canvas></div>
            <h3 style="color:var(--ey); margin-top:20px;">FLEET PERFORMANCE SUMMARY</h3>
            <table class="summary-table" id="summary-tbl">
                <thead>
                    <tr><th>Rig ID</th><th>Audits</th><th>Load%</th><th>Temp</th><th>Oil</th><th>Fuel</th><th>Air</th><th>Bit</th><th>Imp</th></tr>
                </thead>
                <tbody id="fleet-summary-body"></tbody>
            </table>
        </div>

        <div class="warning-sidebar">
            <h3 style="color:var(--red);">⚠️ TRIGGER ALERTS</h3>
            <div id="alert-list">Scanning...</div>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwRej9svw3UUlzxzQZSM3EjcFDbV03RCwGZx5dApN4NUNg2PTH5gPUv-04otvWoVy71/exec"; 
    let chart = null, globalData = null;

    async function handleLogin() {
        const u = document.getElementById('userIn').value, p = document.getElementById('passIn').value;
        const resp = await fetch(`${API}?get=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
        const data = await resp.json();
        if (data.success) {
            sessionStorage.setItem('region', data.region); sessionStorage.setItem('siteView', data.siteView); sessionStorage.setItem('user', u);
            document.body.classList.add('authorized');
            init(); 
        } else { document.getElementById('login-msg').innerText = "Invalid Access."; }
    }

    function getFullUrl(params) {
        const r = sessionStorage.getItem('region'), s = sessionStorage.getItem('siteView'), u = sessionStorage.getItem('user');
        return `${API}?${params}&userRegion=${r}&siteView=${s}&user=${u}&v=${Date.now()}`;
    }

    async function init() {
        const now = new Date(); document.getElementById('monthFilter').value = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
        const mRes = await fetch(getFullUrl("get=model_list"));
        const mList = await mRes.json();
        document.getElementById('modelSelect').innerHTML = '<option value="">All Models</option>' + mList.map(m => `<option value="${m}">${m}</option>`).join('');
        updateRigDropdown(); 
    }

    async function updateRigDropdown() {
        const m = document.getElementById('modelSelect').value;
        const res = await fetch(getFullUrl(`get=list&model=${encodeURIComponent(m)}`));
        const rigs = await res.json();
        document.getElementById('rigSelect').innerHTML = rigs.map(id => `<option value="${id}">${id}</option>`).join('');
        refresh();
    }

    async function refresh() {
        const rig = document.getElementById('rigSelect').value, month = document.getElementById('monthFilter').value;
        try {
            const res = await fetch(getFullUrl(`fleetId=${encodeURIComponent(rig)}&month=${month}`));
            const data = await res.json();
            globalData = data;
            if (data.summary) {
                document.getElementById('fleet-summary-body').innerHTML = data.summary.map(r => `<tr><td>${r.id}</td><td>${r.audits}</td><td>${r.avgLoad}%</td><td>${r.avgTemp}</td><td>${r.avgOil}</td><td>${r.avgFuel}</td><td>${r.avgAir}</td><td>${r.avgBit}</td><td>${r.avgImpact}</td></tr>`).join('');
            }
            if (data.vitals) {
                document.getElementById('v-date').innerText = data.vitals.date;
                document.getElementById('v-boost').innerText = data.vitals.boost;
                document.getElementById('v-fuel').innerText = data.vitals.fuel;
                document.getElementById('v-hyd-temp').innerText = data.vitals.hyd + "°C";
                const al = document.getElementById('alert-list');
                if (data.vitals.alerts.length > 0) {
                    al.innerHTML = data.vitals.alerts.map(a => `<div style="border-left:5px solid red; background:rgba(255,0,0,0.1); padding:10px; margin-bottom:5px; animation: blinker 1.5s infinite;"><b style="color:red;">⚠️ ${a.parameter}</b><br><small>Value: ${a.value} | Limit: ${a.limit}</small></div>`).join('');
                } else { al.innerHTML = "✅ SYSTEMS NORMAL"; }
            }
            drawChart();
        } catch (e) { console.error(e); }
    }

    function drawChart() {
        if (!globalData || !globalData.monthlyData) return;
        const ctx = document.getElementById('mainChart').getContext('2d'), d = globalData.monthlyData;
        if (chart) chart.destroy();
        const mode = document.getElementById('chartMode').value;
        
        let datasets = [], options = { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { color: '#333' } } }, plugins: { annotation: { annotations: {} } } };

        if (mode === 'tempVsOil') {
            datasets = [
                { label: 'Oil bar', data: d.map(x => x.oil), borderColor: '#2ecc71', yAxisID: 'yLeft' },
                { label: 'Temp °C', data: d.map(x => x.temp), borderColor: '#e74c3c', yAxisID: 'yTemp' },
                { label: 'RPM', data: d.map(x => x.rpm), borderColor: '#3498db', yAxisID: 'yRPM' }
            ];
            options.scales = {
                yLeft: { position: 'left', min: 0, max: 5 },
                yTemp: { position: 'right', min: 0, max: 150 },
                yRPM: { position: 'right', min: 100, max: 2200, grid: { drawOnChartArea: false } }
            };
            options.plugins.annotation.annotations.line1 = { type: 'line', yMin: 102, yMax: 102, yScaleID: 'yTemp', borderColor: 'red', borderDash: [6,6], label: { display: true, content: '102°C' } };
        } else {
            datasets = [{ label: 'Performance', data: d.map(x => x.load), borderColor: '#f1c40f' }];
            options.scales = { y: { min: 0, max: 100 } };
        }
        chart = new Chart(ctx, { type: 'line', data: { labels: d.map(x => x.date), datasets }, options });
    }
</script>
</body>
</html>
