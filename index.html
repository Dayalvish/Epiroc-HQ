<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epiroc Management Analytics | Executive Oversight</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ey: #f1c40f; --bg: #0d0d0d; --card: #1a1a1a; --red: #ff4d4d; --green: #27ae60; --dim: #888; }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; opacity: 0; transition: 0.5s; }
        .authorized { opacity: 1 !important; }

        /* Header Styling */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--ey); padding-bottom: 10px; margin-bottom: 20px; }
        .live-status { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #2ecc71; }
        .dot { height: 10px; width: 10px; background: #2ecc71; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }

        /* Statistics Ribbon */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card); padding: 15px; border-radius: 8px; border-top: 4px solid var(--ey); text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .stat-box small { color: var(--dim); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 1px; }
        .stat-box div { font-size: 1.8rem; font-weight: bold; color: var(--ey); margin-top: 5px; }

        /* Main Layout */
        .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; }
        .sidebar, .chart-area, .warning-sidebar { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

        /* Warning Sidebar */
        .warning-sidebar { border: 1px solid var(--red); height: 650px; overflow-y: auto; }
        .alert-card { background: #2d0000; border-left: 4px solid var(--red); padding: 12px; margin-bottom: 10px; font-size: 0.8rem; }
        .alert-card b { color: var(--red); font-size: 0.9rem; display: block; margin-bottom: 4px; }

        /* Summary Table */
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 25px; background: #111; border-radius: 8px; overflow: hidden; font-size: 0.85rem; }
        .summary-table th, .summary-table td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        .summary-table th { background: #222; color: var(--ey); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-table tr:hover { background: #1a1a1a; }

        /* Form Elements */
        label { font-size: 0.8rem; color: var(--dim); font-weight: bold; display: block; margin-top: 15px; }
        select, input { width: 100%; padding: 12px; margin-top: 5px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
        
        /* Action Buttons */
        .btn-report { width: 100%; padding: 12px; margin-top: 10px; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-report:hover { filter: brightness(1.2); }

        /* Print Optimization */
        @media print {
            .sidebar, .btn-report, .warning-sidebar, .live-status { display: none !important; }
            .main-layout { grid-template-columns: 1fr !important; }
            body { background: white !important; color: black !important; padding: 0; }
            .chart-area { box-shadow: none; border: 1px solid #ddd; }
            .summary-table th { background: #eee; color: black; border: 1px solid #ddd; }
            .summary-table td { border: 1px solid #ddd; }
        }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1 style="margin:0; font-size: 1.8rem; letter-spacing: 1px;">EPIROC <span style="color:var(--ey)">EXECUTIVE</span> OVERSIGHT</h1>
        <div class="live-status"><div class="dot"></div> LIVE FLEET FEED | <span id="last-sync">--:--:--</span></div>
    </div>
    <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="55">
</div>

<div class="stat-grid">
    <div class="stat-box"><small>Audits (Selected Month)</small><div id="s-count">0</div></div>
    <div class="stat-box"><small>Avg Engine Load</small><div id="s-load">0%</div></div>
    <div class="stat-box"><small>Latest Engine RPM</small><div id="s-rpm">0</div></div>
</div>

<div class="main-layout">
    <div class="sidebar">
        <label>Machine Selection</label>
        <select id="rigSelect" onchange="refresh()"><option>Loading Rigs...</option></select>
        
        <label>Target Analysis Month</label>
        <input type="month" id="monthFilter" onchange="refresh()">
        
        <label>Performance Correlation</label>
        <select id="chartMode" onchange="drawChart()">
            <option value="loadVsComp">Load vs Compressor %</option>
            <option value="tempVsOil">Temp vs Oil Pressure</option>
            <option value="compVsRpm">Comp Temp vs Engine RPM</option>
        </select>

        <div style="margin-top:40px; border-top: 1px solid #333; padding-top: 20px;">
            <label style="margin-bottom:10px;">EXECUTIVE REPORTS</label>
            <button class="btn-report" onclick="window.print()" style="background:#e74c3c;">üìÑ Generate PDF Report</button>
            <button class="btn-report" onclick="exportToExcel()" style="background:var(--green);">üìä Export Fleet Excel</button>
        </div>
    </div>

    <div class="chart-area">
        <div style="height:400px; width:100%;"><canvas id="mainChart"></canvas></div>
        
        <h3 style="color:var(--ey); margin-top:40px; border-left: 4px solid var(--ey); padding-left: 10px;">MONTHLY PERFORMANCE SUMMARY</h3>
        <table class="summary-table" id="summary-tbl">
            <thead>
                <tr>
                    <th>Rig ID</th>
                    <th>Monthly Audits</th>
                    <th>Total Audits</th>
                    <th>Avg Load (%)</th>
                    <th>Avg Oil (bar)</th>
                    <th>Avg Temp (¬∞C)</th>
                    <th>Last Entry</th>
                </tr>
            </thead>
            <tbody id="fleet-summary-body">
                <tr><td colspan="7" style="text-align:center;">Initializing data sync...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="warning-sidebar">
        <h3 style="color:var(--red); margin:0 0 15px 0; font-size: 1rem; text-align: center; border-bottom: 1px solid #400; padding-bottom: 10px;">‚ö†Ô∏è CRITICAL FLEET ALERTS</h3>
        <div id="alert-list">Scanning database...</div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const API = "https://script.google.com/macros/s/AKfycbzNaLlFNWZa-lfXv_xnJDd47A2NabRKxRm8HXAQ6xZYUSYIWNE-7tYII49nFVKpNOl9/exec"; 
    let chart = null;
    let globalData = null;

    // --- 2. SECURITY HANDSHAKE ---
    window.onload = async () => {
        const u = prompt("Management Username:");
        const p = prompt("Management Password:");
        try {
            const res = await fetch(`${API}?get=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
            const data = await res.json();
            if(data.success) {
                document.body.classList.add('authorized');
                init();
            } else { 
                alert("Unauthorized Access. Dashboard Locked."); 
                location.reload(); 
            }
        } catch(e) { 
            alert("Handshake Failed. Check Deployment URL."); 
        }
    };

    // --- 3. INITIALIZATION ---
    async function init() {
        try {
            const res = await fetch(`${API}?get=list&v=${Date.now()}`);
            const list = await res.json();
            document.getElementById('rigSelect').innerHTML = list.map(id => `<option value="${id}">${id}</option>`).join('');
            
            // Auto-Refresh cycle (every 60 seconds)
            setInterval(refresh, 60000); 
            refresh();
        } catch(e) { console.error("List Load Error"); }
    }

    // --- 4. DATA REFRESH LOGIC ---
    async function refresh() {
        const rig = document.getElementById('rigSelect').value;
        const month = document.getElementById('monthFilter').value;
        if(!rig) return;

        try {
            // Simultaneous fetch for speed
            const [dRes, wRes, sRes] = await Promise.all([
                fetch(`${API}?fleetId=${encodeURIComponent(rig)}&month=${month}&v=${Date.now()}`),
                fetch(`${API}?get=warnings&v=${Date.now()}`),
                fetch(`${API}?get=fleet_summary&month=${month}&v=${Date.now()}`)
            ]);

            globalData = await dRes.json();
            const alerts = await wRes.json();
            const summary = await sRes.json();

            // Update Statistics Ribbon
            document.getElementById('s-count').innerText = globalData.stats.auditCount;
            document.getElementById('s-load').innerText = globalData.stats.avgLoad + "%";
            document.getElementById('s-rpm').innerText = globalData.latest[7] || "0";
            document.getElementById('last-sync').innerText = new Date().toLocaleTimeString();

            // Update Alerts Sidebar
            document.getElementById('alert-list').innerHTML = alerts.length ? alerts.map(a => `
                <div class="alert-card">
                    <b>${a.id}</b>
                    ${a.oil < a.oilLimit ? `<span style="color:#ff9999">‚ùå Low Oil: ${a.oil} bar</span><br>` : ''}
                    ${a.temp > a.tempLimit ? `<span style="color:#ff9999">‚ùå High Temp: ${a.temp}¬∞C</span>` : ''}
                    <div style="color:#888; font-size:0.7rem; margin-top:5px;">Log Time: ${a.time}</div>
                </div>
            `).join('') : "<p style='color:#2ecc71; text-align:center;'>‚úÖ Fleet Operations Normal</p>";

            // Update Summary Table (Fixed Naming Handshake)
            document.getElementById('fleet-summary-body').innerHTML = summary.length ? summary.map(row => `
                <tr>
                    <td><b>${row.id}</b></td>
                    <td>${row.monthlyAudits}</td>
                    <td>${row.totalAudits}</td>
                    <td>${row.avgLoad}%</td>
                    <td>${row.avgOil}</td>
                    <td>${row.avgTemp}</td>
                    <td>${row.lastUpdate}</td>
                </tr>
            `).join('') : "<tr><td colspan='7' style='text-align:center;'>No data available for this selection.</td></tr>";

            drawChart();
        } catch (e) { console.error("Sync Error", e); }
    }

    // --- 5. REPORTING ---
    function exportToExcel() {
        const table = document.getElementById("summary-tbl");
        const html = table.outerHTML;
        const blob = new Blob([html], { type: "application/vnd.ms-excel" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = "Fleet_Health_Report_" + (document.getElementById('monthFilter').value || "Full") + ".xls";
        link.href = url;
        link.click();
    }

    // --- 6. CHART ENGINE (Dual Axis) ---
    function drawChart() {
        const mode = document.getElementById('chartMode').value;
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();

        const d = globalData.monthlyData;
        let datasets = [];

        if(mode === 'loadVsComp') {
            datasets = [
                { label: 'Engine Load %', data: d.map(x => x.engLoad), borderColor: '#f1c40f', backgroundColor: 'transparent', yAxisID: 'y' },
                { label: 'Compressor % (Col V)', data: d.map(x => x.compPerc), borderColor: '#3498db', backgroundColor: 'transparent', yAxisID: 'y' }
            ];
        } else if(mode === 'tempVsOil') {
            datasets = [
                { label: 'Eng Temp ¬∞C', data: d.map(x => x.engTemp), borderColor: '#e74c3c', backgroundColor: 'transparent', yAxisID: 'y' },
                { label: 'Oil Press (bar)', data: d.map(x => x.engOil), borderColor: '#2ecc71', backgroundColor: 'transparent', yAxisID: 'y1' }
            ];
        } else {
            datasets = [
                { label: 'Comp Temp ¬∞C', data: d.map(x => x.compLow), borderColor: '#e67e22', backgroundColor: 'transparent', yAxisID: 'y' },
                { label: 'Engine RPM', data: d.map(x => x.engRpm), borderColor: '#9b59b6', backgroundColor: 'transparent', yAxisID: 'y1' }
            ];
        }

        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: d.map(x => x.date), datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { grid: { color: '#333' }, ticks: { color: '#888' } },
                    y: { position: 'left', grid: { color: '#333' }, ticks: { color: '#888' }, title: { display: true, text: 'Primary Scale', color: '#888' } },
                    y1: { display: (mode !== 'loadVsComp'), position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#888' }, title: { display: true, text: 'Secondary Scale', color: '#888' } }
                },
                plugins: { 
                    legend: { labels: { color: '#fff', font: { size: 12 } } },
                    tooltip: { backgroundColor: '#222', titleColor: '#ey', bodyColor: '#fff', borderColor: '#444', borderWidth: 1 }
                }
            }
        });
    }
</script>
</body>
</html>
