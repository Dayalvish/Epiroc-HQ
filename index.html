<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Epiroc Executive Oversight</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ey: #f1c40f; --bg: #0d0d0d; --card: #1a1a1a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; opacity:0; transition: 0.5s; }
        .authorized { opacity: 1 !important; }
        .header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--ey); padding-bottom: 10px; margin-bottom: 20px; }
        .main-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        .sidebar, .chart-area { background: var(--card); padding: 20px; border-radius: 8px; }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #111; font-size: 0.85rem; }
        .summary-table th, .summary-table td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        .summary-table th { background: #222; color: var(--ey); text-transform: uppercase; font-size: 0.7rem; }
        select, input { width: 100%; padding: 12px; margin-top: 8px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="margin:0;">EPIROC EXECUTIVE OVERSIGHT</h1>
    <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="50">
</div>

<div class="main-layout">
    <div class="sidebar">
        <label>Filter by Model</label>
        <select id="modelSelect" onchange="refreshSummaryOnly()"><option value="">All Models</option></select>
        
        <label style="display:block; margin-top:15px;">Select Machine</label>
        <select id="rigSelect" onchange="refresh()"><option>Loading...</option></select>
        
        <label style="display:block; margin-top:15px;">Target Month</label>
        <input type="month" id="monthFilter" onchange="refresh()">
    </div>

    <div class="chart-area">
        <div style="height:350px;"><canvas id="mainChart"></canvas></div>
        <h3 style="color:var(--ey); margin-top:30px;">FLEET PERFORMANCE SUMMARY</h3>
        <table class="summary-table">
            <thead>
                <tr><th>Rig ID</th><th>Model</th><th>Audits (Mon)</th><th>Total Audits</th><th>Avg Load</th><th>Avg Oil</th><th>Avg Temp</th></tr>
            </thead>
            <tbody id="fleet-summary-body"></tbody>
        </table>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwAoNu58pvhzp-grH6r8_5Wu-0FywgSAYlup1ac813180FT0OHwHwCgSi4rFeuyyYlx/exec";
    let chart = null, globalData = null;

    window.onload = async () => {
        const u = prompt("Management ID"), p = prompt("Password");
        const res = await fetch(`${API}?get=login&user=${u}&pass=${p}`);
        const data = await res.json();
        if(data.success) { document.body.classList.add('authorized'); init(); } 
        else { location.reload(); }
    };

    async function init() {
        const [rRes, mRes] = await Promise.all([
            fetch(`${API}?get=list`),
            fetch(`${API}?get=model_list`)
        ]);
        const rList = await rRes.json();
        const mList = await mRes.json();
        
        document.getElementById('rigSelect').innerHTML = rList.map(id => `<option value="${id}">${id}</option>`).join('');
        document.getElementById('modelSelect').innerHTML = '<option value="">All Models</option>' + mList.map(m => `<option value="${m}">${m}</option>`).join('');
        
        refresh();
    }

    async function refresh() {
        const rig = document.getElementById('rigSelect').value, month = document.getElementById('monthFilter').value;
        const model = document.getElementById('modelSelect').value;
        if(!rig) return;

        const [dRes, sRes] = await Promise.all([
            fetch(`${API}?fleetId=${encodeURIComponent(rig)}&month=${month}&v=${Date.now()}`),
            fetch(`${API}?get=fleet_summary&month=${month}&model=${model}&v=${Date.now()}`)
        ]);

        globalData = await dRes.json();
        const summary = await sRes.json();

        document.getElementById('fleet-summary-body').innerHTML = summary.map(row => `
            <tr>
                <td><b>${row.id}</b></td>
                <td>${row.model}</td>
                <td>${row.monthlyAudits}</td>
                <td>${row.totalAudits}</td>
                <td>${row.avgLoad}%</td>
                <td>${row.avgOil} bar</td>
                <td>${row.avgTemp}°C</td>
            </tr>
        `).join('');
        drawChart();
    }

    async function refreshSummaryOnly() {
        const month = document.getElementById('monthFilter').value;
        const model = document.getElementById('modelSelect').value;
        const sRes = await fetch(`${API}?get=fleet_summary&month=${month}&model=${model}&v=${Date.now()}`);
        const summary = await sRes.json();
        
        document.getElementById('fleet-summary-body').innerHTML = summary.map(row => `
            <tr>
                <td><b>${row.id}</b></td>
                <td>${row.model}</td>
                <td>${row.monthlyAudits}</td>
                <td>${row.totalAudits}</td>
                <td>${row.avgLoad}%</td>
                <td>${row.avgOil} bar</td>
                <td>${row.avgTemp}°C</td>
            </tr>
        `).join('');
    }

    function drawChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        const d = globalData.monthlyData;
        
        chart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: d.map(x => x.date), 
                datasets: [
                    { label: 'Eng Load %', data: d.map(x => x.engLoad), borderColor: '#f1c40f' },
                    { label: 'Comp % (Col V)', data: d.map(x => x.compPerc), borderColor: '#3498db' }
                ] 
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>
